{% extends 'base.html' %}

{% block title %}Test Jarayoni{% endblock %}

{% block content %}
<div class="h-screen flex flex-col bg-gray-100 select-none" id="test-app" oncontextmenu="return false;">
    <noscript>
        <div class="fixed inset-0 bg-red-900 z-50 flex flex-col items-center justify-center text-white text-center p-8">
            <h1 class="text-3xl font-bold mb-4">DIQQAT!</h1>
            <p class="text-xl mb-6">Talaba, sizda JavaScript o'chirilgan yoki bloklangan.</p>
            <p class="mb-8">Tizimda ishlash uchun va Test topshirish uchun <strong>Javascript yoqilishi shart!</strong>
            </p>
            <p class="text-sm bg-white text-red-900 px-4 py-2 rounded">Sozlamalarga kirib Javascriptni yoqing va
                sahifani yangilang.</p>
        </div>
    </noscript>
    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
        <h2 class="text-xl font-bold text-gray-800" id="test-title">Yuklanmoqda...</h2>
        <div class="flex items-center space-x-6">
            <div class="text-lg font-mono font-bold text-primary-900 bg-blue-100 px-4 py-1 rounded" id="timer">--:--
            </div>
            <div class="text-sm text-gray-600">
                Savol: <span id="current-q-num">1</span>/<span id="total-q-count">--</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 overflow-hidden flex">
        <!-- Questions Sidebar -->
        <div class="w-64 bg-white border-r p-4 overflow-y-auto hidden md:block">
            <h3 class="font-bold mb-4">Savollar</h3>
            <div class="grid grid-cols-4 gap-2" id="questions-grid">
                <!-- Javascript will populate this -->
            </div>
        </div>

        <!-- Question Area -->
        <div class="flex-1 p-8 overflow-y-auto flex flex-col items-center">
            <div class="w-full max-w-3xl bg-white p-8 rounded-lg shadow-lg">
                <div class="mb-6">
                    <span class="inline-block bg-primary-100 text-primary-800 text-xs px-2 py-1 rounded mb-2">Savol
                        #<span id="q-index"></span></span>
                    <p class="text-xl font-medium text-gray-800" id="question-text"></p>
                </div>

                <div class="space-y-3" id="options-container">
                    <!-- Options injected here -->
                </div>

                <div class="mt-8 flex justify-between">
                    <button id="prev-btn"
                        class="px-6 py-2 border border-gray-300 rounded hover:bg-gray-50 text-gray-600">Oldingi</button>
                    <button id="next-btn"
                        class="px-6 py-2 bg-primary-900 text-white rounded hover:bg-primary-800">Keyingi</button>
                    <button id="finish-btn"
                        class="hidden px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">Yakunlash</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Start Warning Modal -->
    <div id="start-warning-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-8 text-center max-h-[90vh] overflow-y-auto">
            <div class="mb-4 text-red-600">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 uppercase tracking-wide">‚ö†Ô∏è Test Qoidalari</h2>
            <ul class="text-left text-gray-700 space-y-2 mb-6 bg-gray-50 p-6 rounded-lg border border-gray-200 text-sm">
                <li class="flex items-start"><span class="mr-2 text-lg">üñ•</span> Test faqat <strong>to‚Äòliq ekran
                        (Fullscreen)</strong> rejimida ishlaydi.</li>
                <li class="flex items-start"><span class="mr-2 text-lg">üì∑</span> Kamera test
                    davomida doimiy yoqilgan bo‚Äòlishi shart.</li>
                <li class="flex items-start"><span class="mr-2 text-lg">üö´</span> Boshqa ilovaga yoki brauzer oynasiga
                    o‚Äòtish (Alt+Tab) taqiqlanadi.</li>
                <li class="flex items-start"><span class="mr-2 text-lg">üîÑ</span> Sahifani yangilash (F5, Ctrl+R) mumkin
                    emas.</li>
                <li class="flex items-start"><span class="mr-2 text-lg">‚¨ÖÔ∏è</span> Orqaga qaytish (Back) taqiqlanadi.
                </li>
                <li class="flex items-start"><span class="mr-2 text-lg">üì∂</span> Internet uzilib qolsa vaqt
                    hisoblanishda davom etadi.</li>
                <li class="flex items-start"><span class="mr-2 text-lg">üë§</span> Bitta foydalanuvchi faqat bitta
                    qurilmadan kirishi mumkin.</li>
                <li class="flex items-start"><span class="mr-2 text-lg">‚è±</span> Belgilangan vaqt tugaganda test
                    avtomatik topshiriladi.</li>
                <li class="flex items-start"><span class="mr-2 text-lg">üì∏</span> Kamera orqali bir nechta odam
                    aniqlansa yoki telefon / shpargalka ko‚Äòrinib qolsa test tasdiqlanmasligi mumkin.</li>
                <li class="flex items-start font-bold text-red-600"><span class="mr-2 text-lg">‚ö†Ô∏è</span> Qoidalar
                    buzilsa test bloklanadi yoki natija bekor qilinadi.</li>
            </ul>

            <div class="mb-6 flex items-center justify-center space-x-2">
                <input type="checkbox" id="rules-agree"
                    class="w-5 h-5 text-red-600 rounded focus:ring-red-500 border-gray-300 cursor-pointer"
                    onchange="document.getElementById('start-test-btn').disabled = !this.checked; document.getElementById('start-test-btn').classList.toggle('opacity-50', !this.checked); document.getElementById('start-test-btn').classList.toggle('cursor-not-allowed', !this.checked);">
                <label for="rules-agree" class="text-gray-800 font-medium cursor-pointer select-none">Men barcha
                    qoidalar bilan tanishdim va roziman</label>
            </div>

            <button id="start-test-btn" onclick="startActualTest()" disabled
                class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition transform hover:scale-105 opacity-50 cursor-not-allowed">
                üî¥ Tushundim va Testni Boshlash
            </button>
        </div>
    </div>

    <!-- Violation Overlay (Blur) -->
    <div id="violation-overlay"
        class="fixed inset-0 z-[60] backdrop-blur-md bg-white/30 flex items-center justify-center hidden">
        <div class="bg-white/90 p-8 rounded-xl shadow-2xl max-w-md text-center border-4 border-red-500 animate-pulse">
            <h2 id="violation-title" class="text-3xl font-black text-red-600 mb-4 uppercase tracking-wider">DIQQAT!</h2>
            <p id="violation-msg" class="text-lg font-bold text-gray-800 mb-6">
                Talaba, siz test qoidalarini buzdingiz!
            </p>
            <button onclick="resolveViolation()"
                class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition">
                Testni Davom Ettirish
            </button>
        </div>
    </div>

    <!-- Camera Preview Element (Hidden or Floating) -->
    <!-- Camera Preview Element (Floating) -->
    <div id="camera-container"
        class="fixed bottom-4 right-4 w-48 h-36 bg-black border-2 border-white rounded shadow-2xl z-40 overflow-hidden hidden">
        <!-- Created dynamically or inserted here -->
    </div>
</div>



{% endblock %}

{% block scripts %}
<script>
    const TEST_ID = "{{ test_id }}";
    let questions = [];
    let currentQuestionIndex = 0;
    let answers = {};
    let timeLeft = 0;
    let timerInterval;
    let isTestRunning = false;
    let cameraRequired = false;

    // Helpers
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Core Logic
    async function initTest() {
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login/';
            return;
        }

        try {
            // Fetch Test Data first
            const testRes = await axios.get(`/api/tests/${TEST_ID}/start/`, {
                headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
            });
            const testData = testRes.data;

            // Setup local data
            document.getElementById('test-title').textContent = testData.title;
            timeLeft = testData.duration * 60;
            questions = testData.questions || [];
            cameraRequired = testData.is_camera_required;

            // Pre-shuffle options
            questions.forEach(q => {
                const baseOpts = [
                    { key: 'A', text: q.option_a },
                    { key: 'B', text: q.option_b },
                    { key: 'C', text: q.option_c },
                    { key: 'D', text: q.option_d }
                ];
                q.shuffledOptions = shuffleArray(baseOpts);
            });

            document.getElementById('total-q-count').textContent = questions.length;

            // Show Start Warning Modal
            document.getElementById('start-warning-modal').classList.remove('hidden');

        } catch (error) {
            console.error(error);
            showModal("Xatolik", error.response?.data?.error || error.message, () => {
                window.location.href = '/dashboard/';
            });
        }
    }

    async function startActualTest() {
        // 1. Request Fullscreen
        try {
            const docEl = document.documentElement;
            if (docEl.requestFullscreen) await docEl.requestFullscreen();
            else if (docEl.mozRequestFullScreen) await docEl.mozRequestFullScreen();
            else if (docEl.webkitRequestFullscreen) await docEl.webkitRequestFullscreen();
            else if (docEl.msRequestFullscreen) await docEl.msRequestFullscreen();
        } catch (e) {
            console.warn("Fullscreen request failed or denied", e);
            alert("Testni boshlash uchun To'liq Ekran rejimiga o'tish shart! Iltimos, ruxsat bering.");
            return;
        }

        // 2. Start Camera (if required)
        if (cameraRequired) {
            try {
                await startCamera();
            } catch (camError) {
                showModal("Diqqat!", "Kamera talab qilinadi! Iltimos, kamerani yoqing.", () => {
                    // Retry or stay
                });
                return;
            }
        }

        // 3. Close Warning, Start Logic
        document.getElementById('start-warning-modal').classList.add('hidden');

        isTestRunning = true;
        startTimer();
        renderGrid();
        renderQuestion(0);

        // 4. Start Integrity Monitors
        setupIntegrityMonitors();

        // 5. Start Snapshots
        if (cameraRequired) startSnapshotLoop();
    }

    // --- INTEGRITY MONITORS ---
    function setupIntegrityMonitors() {
        // Fullscreen Monitor
        document.addEventListener('fullscreenchange', checkIntegrity);
        document.addEventListener('mozfullscreenchange', checkIntegrity);
        document.addEventListener('webkitfullscreenchange', checkIntegrity);
        document.addEventListener('msfullscreenchange', checkIntegrity);

        // Visibility/Focus Monitor (Tab switch)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isTestRunning) {
                triggerViolation('focus');
            }
        });

        // Window Blur (Alt-Tab / Click away)
        window.addEventListener('blur', () => {
            if (isTestRunning) {
                triggerViolation('focus');
            }
        });

        // Prevent Context Menu
        document.addEventListener('contextmenu', e => e.preventDefault());

        // Prevent Copy/Paste
        document.addEventListener('copy', e => e.preventDefault());
        document.addEventListener('cut', e => e.preventDefault());
        document.addEventListener('paste', e => e.preventDefault());

        // Prevent Shortcuts
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'v' || e.key === 'x' || e.key === 'p')) {
                e.preventDefault();
            }
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
        });
    }

    function checkIntegrity() {
        if (!isTestRunning) return;

        // Check Fullscreen
        const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;

        if (!isFullscreen) {
            triggerViolation('fullscreen');
        } else {
            // If restored
            resolveViolationIfPossible();
        }
    }

    function triggerViolation(type) {
        // Show Overlay
        const overlay = document.getElementById('violation-overlay');
        const title = document.getElementById('violation-title');
        const msg = document.getElementById('violation-msg');

        overlay.classList.remove('hidden');

        if (type === 'fullscreen') {
            title.textContent = "DIQQAT! TO'LIQ EKRAN REJIMI BUZILDI!";
            msg.textContent = "Testni davom ettirish uchun to'liq ekran rejimiga qaytishingiz shart. Iltimos, 'Testni Davom Ettirish' tugmasini bosing.";
        } else if (type === 'focus') {
            title.textContent = "DIQQAT! DIQQATNI YO'QOTDINGIZ!";
            msg.textContent = "Test paytida boshqa oynaga o'tish taqiqlanadi. Iltimos, testga qayting.";
        } else if (type === 'camera') {
            title.textContent = "DIQQAT! KAMERA O'CHIRILDI!";
            msg.textContent = "Kamera ishlamayapti. Davom ettirish uchun kamerani tekshiring.";
        }
    }

    async function resolveViolation() {
        // Try to fix based on current state
        try {
            // Check Fullscreen
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
            if (!isFullscreen) {
                const docEl = document.documentElement;
                if (docEl.requestFullscreen) await docEl.requestFullscreen();
                else if (docEl.mozRequestFullScreen) await docEl.mozRequestFullScreen();
                else if (docEl.webkitRequestFullscreen) await docEl.webkitRequestFullscreen();
                else if (docEl.msRequestFullscreen) await docEl.msRequestFullscreen();
            }

            // Check Camera (simple check if stream active)
            if (cameraRequired && (!videoStream || !videoStream.active)) {
                await startCamera();
            }

            // If we reached here without error, hide overlay if checkIntegrity confirms
            // Small delay to allow FS to engage
            setTimeout(() => {
                const isFS = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
                if (isFS && (!cameraRequired || (videoStream && videoStream.active))) {
                    document.getElementById('violation-overlay').classList.add('hidden');
                }
            }, 500);

        } catch (e) {
            console.error("Resolve failed", e);
            alert("Muammoni hal qilib bo'lmadi. Sozlamalarni tekshiring.");
        }
    }

    function resolveViolationIfPossible() {
        const overlay = document.getElementById('violation-overlay');
        if (!overlay.classList.contains('hidden')) {
            // Check conditions
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
            if (isFullscreen) {
                overlay.classList.add('hidden');
            }
        }
    }

    function startTimer() {
        const timerEl = document.getElementById('timer');
        timerInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                finishTest(true); // Auto finish
            }

            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            timerEl.textContent = `${m}:${s}`;

            // Visual warning
            if (timeLeft < 60) timerEl.classList.add('text-red-600', 'animate-pulse');
        }, 1000);
    }

    function renderGrid() {
        const grid = document.getElementById('questions-grid');
        grid.innerHTML = questions.map((_, i) => `
            <button onclick="renderQuestion(${i})" id="q-btn-${i}" 
                class="w-full aspect-square flex items-center justify-center border rounded hover:bg-gray-100 text-sm font-medium ${answers[questions[i].id] ? 'bg-blue-100 border-blue-300' : 'bg-gray-50'}">
                ${i + 1}
            </button>
        `).join('');
    }

    function renderQuestion(index) {
        if (index < 0 || index >= questions.length) return;
        currentQuestionIndex = index;

        const q = questions[index];
        document.getElementById('q-index').textContent = index + 1;
        document.getElementById('current-q-num').textContent = index + 1;
        document.getElementById('question-text').innerHTML = q.question_text || q.text;

        // Options
        const container = document.getElementById('options-container');

        // Use pre-shuffled options
        const opts = q.shuffledOptions;
        const labels = ['A', 'B', 'C', 'D'];

        // Check if previously answered
        const currentAns = answers[q.id];

        container.innerHTML = opts.map((opt, idx) => {
            const label = labels[idx];
            // We use opt.key (original key) for logic, but label for display
            return `
            <div onclick="selectAnswer(${q.id}, '${opt.key}')" 
                class="p-4 border rounded-lg cursor-pointer transition hover:bg-gray-50 flex items-center cursor-pointer ${currentAns === opt.key ? 'border-primary-500 bg-primary-50 ring-1 ring-primary-500' : 'border-gray-200'}">
                <span class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-700 font-bold mr-3 ${currentAns === opt.key ? 'bg-primary-600 text-white' : ''}">${label}</span>
                <span class="text-gray-800">${opt.text}</span>
            </div>
            `;
        }).join('');

        // Buttons state
        document.getElementById('prev-btn').disabled = index === 0;
        document.getElementById('next-btn').classList.toggle('hidden', index === questions.length - 1);
        document.getElementById('finish-btn').classList.toggle('hidden', index !== questions.length - 1);

        // Update Grid UI
        renderGrid();
    }

    function selectAnswer(qId, key) {
        answers[qId] = key;
        renderQuestion(currentQuestionIndex); // Re-render to show selection
    }

    async function finishTest(auto = false, violation = false) {
        const btn = document.getElementById('finish-btn');
        if (btn && btn.disabled) return; // Already finishing

        isTestRunning = false; // Stop monitors

        if (auto) {
            submitTest(violation);
        } else {
            showModal("Tasdiqlash", "Testni yakunlashga ishonchingiz komilmi?",
                () => { // Confirm
                    submitTest();
                },
                () => { // Cancel
                    if (btn) btn.disabled = false;
                    isTestRunning = true; // Resume monitors
                }
            );
        }
    }

    async function submitTest(violation = false) {
        clearInterval(timerInterval);
        const btn = document.getElementById('finish-btn');
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'Yuklanmoqda...';
        }

        // Remove Fullscreen on end
        if (document.exitFullscreen) document.exitFullscreen().catch(e => { });

        try {
            const res = await axios.post(`/api/tests/${TEST_ID}/submit/`, {
                answers: answers
            }, {
                headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
            });

            // Show Result
            const data = res.data;
            let title = "Natija";
            let msg = data.message;
            if (violation) {
                title = "TEST YAKUNLANDI!";
                msg = "Siz test oynasidan chiqib ketganingiz uchun test avtomatik yakunlandi!\n" + msg;
            }

            showModal(title, msg + `\nTo'plangan ball: ${data.score}/${data.max_score} (${data.percentage.toFixed(1)}%)`, () => {
                window.location.href = '/dashboard/';
            });

        } catch (e) {
            console.error(e);
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Yakunlash';
            }

            // Handle specifically "Already taken" error gracefully
            if (e.response && e.response.status === 400 && e.response.data.error === 'Siz bu testni topshirgansiz.') {
                showModal("Xatolik", "Siz bu testni allaqachon topshirgansiz. Natijalar saqlangan.", () => {
                    window.location.href = '/dashboard/';
                });
                return;
            }

            showModal("Xatolik", "Natijani saqlashda xatolik: " + (e.response?.data?.error || e.message), () => {
                window.location.href = '/dashboard/';
            });
        }
    }

    // Controls
    document.getElementById('prev-btn').onclick = () => renderQuestion(currentQuestionIndex - 1);
    document.getElementById('next-btn').onclick = () => renderQuestion(currentQuestionIndex + 1);
    document.getElementById('finish-btn').onclick = () => finishTest();

    // Camera Logic
    let videoStream;

    async function startCamera() {
        const video = document.getElementById('camera-preview');
        // Ensure video element exists inside camera-box or create if needed
        if (!document.getElementById('camera-preview')) {
            // Should be created in HTML now or below
        }

        // Use user facing camera
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        // Find existing or created video element
        let vidEl = document.getElementById('camera-preview');
        if (!vidEl) {
            vidEl = document.createElement('video');
            vidEl.id = 'camera-preview';
            vidEl.className = "w-full h-full object-cover transform scale-x-[-1]"; // Mirror
            const container = document.getElementById('camera-container');
            container.appendChild(vidEl);
            container.classList.remove('hidden');
        }

        vidEl.srcObject = videoStream;
        vidEl.play();

        // Add stream listener for end
        videoStream.getVideoTracks()[0].onended = () => {
            triggerViolation('camera');
        };
    }

    function startSnapshotLoop() {
        setInterval(async () => {
            if (!isTestRunning) return;
            if (!videoStream || !videoStream.active) return; // Don't snap if camera off

            const video = document.getElementById('camera-preview');
            const canvas = document.createElement('canvas');
            canvas.width = 300; // Low res for bandwidth
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert to blob
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('image', blob, 'snap.jpg');

                try {
                    // Send to server
                    await axios.post(`/api/tests/${TEST_ID}/snapshot/`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data',
                            Authorization: `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });
                } catch (e) {
                    console.error("Snapshot failed", e);
                }
            }, 'image/jpeg', 0.5);

        }, 10000); // 10 seconds
    }

    // Start Init
    initTest();
</script>
{% endblock %}