{% extends 'base.html' %}

{% block title %}Ro'yxat - Universitet Test Tizimi{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100" id="list-app">
    <!-- Sidebar -->
    {% include 'includes/sidebar.html' %}

    <!-- Overlay for mobile -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden glassmorphism"></div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm z-10 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="mr-4 text-gray-600 focus:outline-none md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h2 class="text-xl font-semibold text-gray-800" id="page-title">Yuklanmoqda...</h2>
            </div>
            <div class="flex space-x-4">
                <input type="text" id="searchInput" placeholder="Qidirish..."
                    class="border rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onkeyup="handleSearch(event)">
                <button onclick="openCreateModal()"
                    class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 transition"
                    id="create-btn">
                    + Yangi Qo'shish
                </button>
            </div>
        </header>

        <!-- Dynamic Filters -->
        <div id="filter-container"
            class="bg-gray-50 px-6 py-3 border-b border-gray-200 hidden flex flex-wrap gap-2 items-center">
            <!-- Injected by JS -->
        </div>

        <!-- Bulk Actions Toolbar -->
        <div id="bulk-actions"
            class="bg-blue-50 px-6 py-3 border-b border-blue-200 hidden flex items-center justify-between transition-all duration-300">
            <div class="flex items-center">
                <span class="text-blue-800 text-sm font-semibold mr-4">
                    <span id="selected-count">0</span> ta element tanlangan
                </span>
                <button onclick="clearSelection()" class="text-blue-600 hover:text-blue-800 text-sm underline">Bekor
                    qilish</button>
            </div>
            <div class="space-x-2 flex">
                {% if page == 'results' %}
                <button onclick="executeBulkAction('retake')"
                    class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 transition shadow-sm">
                    üîÑ Qayta topshirishga ruxsat
                </button>
                {% endif %}

                {% if page == 'tests' %}
                <button onclick="executeBulkAction('archive')"
                    class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition shadow-sm">
                    üóÑÔ∏è Arxivlash
                </button>
                {% endif %}

                {% if page == 'archived_tests' %}
                <button onclick="executeBulkAction('unarchive')"
                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition shadow-sm">
                    ‚ôªÔ∏è Arxivdan chiqarish
                </button>
                {% endif %}

                {% if page == 'students' or page == 'groups' %}
                <button onclick="executeBulkAction('activate')"
                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition shadow-sm">
                    ‚úÖ Faollashtirish
                </button>
                <button onclick="executeBulkAction('deactivate')"
                    class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition shadow-sm">
                    üö´ Nofaol qilish
                </button>
                {% endif %}


                <button onclick="executeBulkAction('delete')"
                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition shadow-sm">
                    üóëÔ∏è O'chirish
                </button>

            </div>
        </div>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr id="table-head">
                                <!-- JS Populated -->
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination Controls -->
            <div id="pagination-controls"
                class="hidden flex flex-col md:flex-row items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4 rounded-lg shadow">
                <!-- Mobile View -->
                <div class="flex flex-1 justify-between sm:hidden w-full mb-2">
                    <button id="mobile-prev"
                        class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Oldingi</button>
                    <button id="mobile-next"
                        class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Keyingi</button>
                </div>

                <!-- Desktop View -->
                <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between w-full">
                    <div>
                        <p class="text-sm text-gray-700">
                            Ko'rsatilmoqda <span class="font-medium" id="page-start">1</span> dan <span
                                class="font-medium" id="page-end">10</span> gacha, jami <span class="font-medium"
                                id="total-count">20</span> ta
                            natijadan
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="page-size-select"
                            class="block rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                            <option value="20" selected>20 / sahifa</option>
                            <option value="50">50 / sahifa</option>
                            <option value="100">100 / sahifa</option>
                            <option value="200">200 / sahifa</option>
                        </select>
                        <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                            <button id="prev-page"
                                class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd"
                                        d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="current-page-display"
                                class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">1</span>
                            <button id="next-page"
                                class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd"
                                        d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>

            <div id="loading" class="text-center py-4">Yuklanmoqda...</div>
        </main>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Exceldan Import Qilish</h3>
        <input type="file" id="importFile" class="mb-4">
        <button onclick="submitImport()" class="px-4 py-2 bg-green-600 text-white rounded w-full">Yuklash</button>
        <button onclick="document.getElementById('importModal').classList.add('hidden')"
            class="mt-2 px-4 py-2 bg-gray-300 rounded w-full">Yopish</button>
    </div>
</div>

<!-- Generic CRUD Modal -->
<div id="crudModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">Item</h3>
            <div class="mt-2 px-7 py-3" id="modalFormContainer">
                <!-- Form Fields injected here -->
            </div>
            <div class="items-center px-4 py-3">
                <button id="saveBtn"
                    class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Saqlash
                </button>
                <button onclick="closeCrudModal()"
                    class="mt-3 px-4 py-2 bg-gray-300 text-black text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none">
                    Bekor qilish
                </button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Assign Group Modal -->
<div id="assignGroupModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Guruhga Biriktirish</h3>
        <p class="text-sm text-gray-500 mb-4" id="assign-test-title">Test: ...</p>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Guruhlarni tanlang</label>
            <div id="assign-group-container"
                class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight h-48 overflow-y-auto">
                <!-- Checkboxes injected here -->
                <p class="text-sm text-gray-500">Yuklanmoqda...</p>
            </div>
            <div class="mt-1 text-xs text-gray-500 flex justify-between">
                <button type="button" onclick="toggleAllGroups(true)"
                    class="text-indigo-600 hover:text-indigo-800">Barchasini belgilash</button>
                <button type="button" onclick="toggleAllGroups(false)"
                    class="text-gray-600 hover:text-gray-800">Tozalash</button>
            </div>
        </div>

        <button onclick="submitGroupAssignment()"
            class="px-4 py-2 bg-indigo-600 text-white rounded w-full hover:bg-indigo-700 transition">Biriktirish</button>
        <button onclick="document.getElementById('assignGroupModal').classList.add('hidden')"
            class="mt-2 px-4 py-2 bg-gray-300 rounded w-full hover:bg-gray-400 transition">Yopish</button>
    </div>
</div>

<!-- Dedicated Employee Modal -->
<div id="employeeModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="relative bg-white rounded-xl shadow-2xl max-w-6xl w-full mx-4 my-8 flex flex-col max-h-[90vh]">
        <!-- Header -->
        <div class="px-8 py-5 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
            <h3 class="text-2xl font-bold text-gray-800" id="employeeModalTitle">Yangi Xodim</h3>
            <button onclick="closeEmployeeModal()" class="text-gray-400 hover:text-gray-600 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-8">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Column: Personal Info -->
                <div class="lg:col-span-4 space-y-6">
                    <h4 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Shaxsiy Ma'lumotlar</h4>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ism <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="emp-first_name"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm"
                            placeholder="Ismingiz">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Familiya <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="emp-last_name"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm"
                            placeholder="Familiyangiz">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Login (Username) <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="emp-username"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm"
                            placeholder="Login">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parol <span id="emp-password-req"
                                class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="text" id="emp-password"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm"
                                placeholder="Parol">
                            <p class="text-xs text-gray-400 mt-1" id="emp-password-hint">Tahrirlashda bo'sh qoldirilsa,
                                o'zgarmaydi.</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                        <input type="text" id="emp-phone"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm"
                            placeholder="+998...">
                    </div>
                </div>

                <!-- Right Column: Permissions Matrix -->
                <div class="lg:col-span-8">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h4 class="text-lg font-semibold text-gray-700">Tizim Imkoniyatlari (Ruxsatlar)</h4>
                        <div class="space-x-2">
                            <button type="button" onclick="presetPermissions('dean')"
                                class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-xs font-medium rounded text-gray-700 transition">Dekan
                                Andoza</button>
                            <button type="button" onclick="presetPermissions('teacher')"
                                class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-xs font-medium rounded text-gray-700 transition">O'qituvchi
                                Andoza</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto bg-white rounded-lg border border-gray-200 shadow-sm">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Modul</th>
                                    <th class="px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
                                        title="Ko'rish">üëÅÔ∏è View</th>
                                    <th class="px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
                                        title="O'zgartirish">‚úèÔ∏è Edit</th>
                                    <th class="px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
                                        title="Yaratish">‚ûï Create</th>
                                    <th class="px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
                                        title="O'chirish">üóëÔ∏è Delete</th>
                                    <th class="px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
                                        title="Eksport/Import">üì• Exp/Imp</th>
                                    <th
                                        class="px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        All</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="emp-permissions-body">
                                <!-- Generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-8 py-5 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end space-x-3">
            <button onclick="closeEmployeeModal()"
                class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-200 transition">
                Bekor qilish
            </button>
            <button onclick="saveEmployee()"
                class="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition transform active:scale-95">
                Saqlash
            </button>
        </div>
    </div>
</div>

<script>
    const PAGE = '{{ page }}';
    let currentId = null; // For Edit mode

    let config = {};
    let currentUser = null; // Global user object for permission checks

    // Page Configurations
    const CONFIGS = {
        'employees': {
            title: 'Xodimlar',
            api: '/api/employees/',
            columns: ['F.I.SH', 'Login', 'Telefon', 'Amallar'],
            fields: [
                { name: 'first_name', label: 'Ism', type: 'text' },
                { name: 'last_name', label: 'Familiya', type: 'text' },
                { name: 'username', label: 'Login', type: 'text' },
                { name: 'password', label: 'Parol', type: 'password' },
                { name: 'phone', label: 'Telefon', type: 'text' },
                {
                    name: 'permissions',
                    label: 'Imkoniyatlar',
                    type: 'permissions_matrix',
                    modules: [
                        { val: 'dashboard', text: 'Bosh sahifa' },
                        { val: 'monitoring', text: 'Monitoring' },
                        { val: 'groups', text: 'Guruhlar' },
                        { val: 'students', text: 'Talabalar' },
                        { val: 'results', text: 'Natijalar' },
                        { val: 'vedmost', text: 'Vedmost' },
                        { val: 'directions', text: 'Yo\'nalishlar' },
                        { val: 'subjects', text: 'Fanlar' },
                        { val: 'tests', text: 'Testlar' },
                        { val: 'employees', text: 'Xodimlar' },
                        // Legacy
                        { val: 'log_system', text: 'Loglar' }
                    ]
                }
            ],
            render: (item) => {
                let canUpdate = false;
                let canDelete = false;

                if (currentUser) {
                    if (currentUser.role === 'admin') {
                        canUpdate = true;
                        canDelete = true;
                    } else if (currentUser.permissions) {
                        const perm = currentUser.permissions.find(p => p.module === 'employees');
                        if (perm) {
                            if (perm.can_update) canUpdate = true;
                            if (perm.can_delete) canDelete = true;
                        }
                    }
                }

                return `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold">${item.first_name} ${item.last_name}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.username}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.phone || '-'}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    ${canUpdate ? `<button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-900 mr-2">Tahrirlash</button>` : ''}
                    ${canDelete ? `<button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900">O'chirish</button>` : ''}
                </td>
            `;
            }
        },
        'students': {
            title: 'Talabalar',
            api: '/api/students/',
            importApi: '/api/students/import/', // Import Endpoint
            columns: ['<input type="checkbox" id="select-all-cb" onchange="toggleAll(this.checked)">', 'ID', 'F.I.SH', 'Guruh', 'Telefon', 'Holat', 'Amallar'],
            fields: [
                { name: 'full_name', label: 'F.I.SH', type: 'text' },
                { name: 'student_id', label: 'Talaba ID', type: 'text' },
                { name: 'course', label: 'Kurs', type: 'number' },
                {
                    name: 'education_form', label: 'Ta\'lim Shakli', type: 'select', options: [
                        { val: 'kunduzgi', text: 'Kunduzgi' }, { val: 'sirtqi', text: 'Sirtqi' }, { val: 'kechki', text: 'Kechki' }
                    ]
                },
                { name: 'direction', label: 'Yo\'nalish', type: 'select', options: [] }, // Dynamic
                { name: 'group', label: 'Guruh', type: 'select', options: [] }, // Dynamic
                { name: 'phone', label: 'Telefon', type: 'text' },
                { name: 'email', label: 'Email', type: 'email' },
                {
                    name: 'camera_mode',
                    label: 'Kamera Rejimi',
                    type: 'select',
                    options: [
                        { val: 'default', text: 'Global sozlamaga bo\'ysunish' },
                        { val: 'required', text: 'Doimiy majburiy' },
                        { val: 'not_required', text: 'Majburiy emas' }
                    ]
                },
                {
                    name: 'status', label: 'Status', type: 'select', options:
                        [{ val: 'active', text: 'Active' }, { val: 'academic_leave', text: 'Academic Leave' }, { val: 'expelled', text: 'Expelled' }]
                },
                { name: 'username', label: 'Login', type: 'text', placeholder: 'Avtomatik (ID) yoki kiriting' },
                { name: 'password', label: 'Parol', type: 'text', placeholder: 'Kiritilmasa, eski parol qoladi' },
                { name: 'is_system_active', label: 'Tizimga kirish', type: 'checkbox' }
            ],
            render: (item) => {
                let canUpdate = false;
                let canDelete = false;
                if (currentUser) {
                    if (currentUser.role === 'admin') { canUpdate = true; canDelete = true; }
                    else if (currentUser.permissions) {
                        const perm = currentUser.permissions.find(p => p.module === 'students');
                        if (perm) {
                            if (perm.can_update) canUpdate = true;
                            if (perm.can_delete) canDelete = true;
                        }
                    }
                }

                return `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">
                    <input type="checkbox" class="row-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="${item.id}" onchange="updateToolbar()">
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.student_id}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold">${item.full_name}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.group_details ? item.group_details.name : '-'}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.phone}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    ${canUpdate ? `
                    <button onclick="toggleStudentStatus(${item.id}, ${item.is_system_active})" 
                        class="px-2 py-1 rounded text-xs font-semibold ${item.is_system_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${item.is_system_active ? 'Faol' : 'Faol emas'}
                    </button>` : `<span class="px-2 py-1 rounded text-xs font-semibold ${item.is_system_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${item.is_system_active ? 'Faol' : 'Faol emas'}</span>`}
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    ${canUpdate ? `<button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-900 mr-2">Tahrirlash</button>` : ''}
                    ${canDelete ? `<button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900">O'chirish</button>` : ''}
                </td>
            `;
            }
        },
        'groups': {
            title: 'Guruhlar',
            api: '/api/groups/',
            columns: ['<input type="checkbox" id="select-all-cb" onchange="toggleAll(this.checked)">', 'Nomi', 'Kurs', 'Yo\'nalish', 'Holat', 'Amallar'],
            fields: [
                { name: 'name', label: 'Guruh Nomi', type: 'text' },
                { name: 'course', label: 'Kurs', type: 'number' },
                { name: 'direction', label: 'Yo\'nalish', type: 'select', options: [] }, // Options populated dynamically
                { name: 'education_form', label: 'Ta\'lim Shakli', type: 'text', placeholder: 'kunduzgi' },
                { name: 'is_system_active', label: 'Faol', type: 'checkbox' }
            ],
            render: (item) => `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">
                    <input type="checkbox" class="row-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="${item.id}" onchange="updateToolbar()">
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold">${item.name}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.course}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.direction}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <button onclick="toggleGroupStatus(${item.id}, ${item.is_system_active})" 
                        class="px-2 py-1 rounded text-xs font-semibold ${item.is_system_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${item.is_system_active ? 'Faol' : 'Faol emas'}
                    </button>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-900 mr-2">Tahrirlash</button>
                    <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900">O'chirish</button>
                </td>
            `
        },
        'directions': {
            title: 'Yo\'nalishlar',
            api: '/api/directions/',
            columns: ['Nomi', 'Kod', 'Amallar'],
            fields: [
                { name: 'name', label: 'Yo\'nalish Nomi', type: 'text' },
                { name: 'code', label: 'Kod', type: 'text' }
            ],
            render: (item) => `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold">${item.name}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.code}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-900 mr-2">Tahrirlash</button>
                    <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900">O'chirish</button>
                </td>
            `
        },
        'subjects': {
            title: 'Fanlar',
            api: '/api/subjects/',
            columns: ['ID', 'Nomi', 'Kod', 'Amallar'],
            fields: [
                { name: 'name', label: 'Fan Nomi', type: 'text' },
                { name: 'code', label: 'Fan Kodi', type: 'text' },
                { name: 'courses', label: 'Kurslar (vergul bilan, m-n: 1,2)', type: 'text' },
                { name: 'directions', label: 'Yo\'nalish', type: 'select', options: [] },
                { name: 'teacher', label: 'O\'qituvchi', type: 'select', options: [] }
            ],
            render: (item) => `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-gray-500">#${item.id}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold">${item.name}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.code}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-900 mr-2">Tahrirlash</button>
                    <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900">O'chirish</button>
                </td>
            `
        },
        'archived_tests': {
            title: 'Arxivlangan Testlar',
            api: '/api/tests/?archived=true',
            columns: ['<input type="checkbox" id="select-all-cb" onchange="toggleAll(this.checked)">', 'Nomi', 'Fan', 'Boshlanish', 'Tugash', 'Amallar'],
            fields: [], // Read-only mostly
            render: (item) => `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">
                    <input type="checkbox" class="row-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="${item.id}" onchange="updateToolbar()">
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold text-gray-500">${item.title}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-gray-500">${item.subject_details ? item.subject_details.name : item.subject}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-gray-500">${new Date(item.start_date).toLocaleString()}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-gray-500">${new Date(item.end_date).toLocaleString()}</td>
                 <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm flex items-center">
                    <button onclick="unarchiveItem(${item.id})" class="text-green-600 hover:text-green-900 mr-2 flex items-center shadow-sm border px-2 py-1 rounded" title="Arxivdan chiqarish">
                        ‚ôªÔ∏è Tiklash
                    </button>
                    ${(currentUser && currentUser.role === 'admin') ?
                    `<button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900" title="O'chirish">üóëÔ∏è</button>` : ''}
                </td>
    `
        },
        'tests': {
            title: 'Testlar',
            api: '/api/tests/',
            columns: ['<input type="checkbox" id="select-all-cb" onchange="toggleAll(this.checked)">', 'Nomi', 'Fan', 'Boshlanish', 'Tugash', 'Amallar'],
            fields: [
                { name: 'title', label: 'Test Nomi', type: 'text' },
                { name: 'subject', label: 'Fan (ID)', type: 'number' },
                { name: 'passing_score', label: 'O\'tish Bali', type: 'number' },
                { name: 'start_date', label: 'Boshlanish Vaqti', type: 'datetime-local' },
                { name: 'end_date', label: 'Tugash Vaqti', type: 'datetime-local' },
                { name: 'duration', label: 'Vaqt (daqiqa)', type: 'number' }
            ],
            render: (item) => `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">
                    <input type="checkbox" class="row-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="${item.id}" onchange="updateToolbar()">
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold">${item.title}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.subject_details ? item.subject_details.name : item.subject}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${new Date(item.start_date).toLocaleString()}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${new Date(item.end_date).toLocaleString()}</td>
                 <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm flex items-center">
                    <a href="/tests/edit/${item.id}/" class="text-indigo-600 hover:text-indigo-900 mr-2" title="Guruhga biriktirish">
                        üîó
                    </a>
                    <button onclick="importTestQuestions(${item.id})" class="text-green-600 hover:text-green-900 mr-2" title="Savollarni import qilish">üì•</button>
                    <a href="/tests/edit/${item.id}/" class="text-blue-600 hover:text-blue-900 mr-2" title="Tahrirlash">‚úèÔ∏è</a>
                    <button onclick="archiveItem(${item.id})" class="text-gray-600 hover:text-gray-900 mr-2" title="Arxivlash">üóÑÔ∏è</button>
                    <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900" title="O'chirish">üóëÔ∏è</button>
                </td>
    `
        },
        'results': {
            title: 'Natijalar',
            api: '/api/results/',
            readOnly: true,
            columns: ['<input type="checkbox" id="select-all-cb" onchange="toggleAll(this.checked)">', 'ID', 'Talaba', 'Guruh', 'Test', 'Ball', 'Foiz', 'Tugagan vaqti', 'Sarflangan vaqt', 'Holat', 'Amallar'],
            render: (item) => `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">
                    ${(currentUser && currentUser.role === 'student') ? '' : `<input type="checkbox" class="row-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="${item.id}" onchange="updateToolbar()">`}
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center font-bold text-gray-500">
                    #${item.id}
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <div>
                        <p class="text-gray-900 whitespace-no-wrap font-bold">${item.student_details ? item.student_details.full_name : '-'}</p>
                    </div>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.student_details && item.student_details.group_details ? item.student_details.group_details.name : '-'}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.test_details ? item.test_details.title : '-'}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">${item.score} / ${item.max_score}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold">${item.percentage}%</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">${item.formatted_completed_at || '-'}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">${item.duration || '-'}</td>
                 <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <span class="px-2 py-1 rounded ${item.status === 'passed' ? 'bg-green-200 text-green-900' : 'bg-red-200 text-red-900'}">${item.status}</span>
                 </td>
                 <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    ${(currentUser && (currentUser.role === 'admin' || currentUser.role === 'dean')) ?
                    `<button onclick="allowRetake(${item.id})" class="text-indigo-600 hover:text-indigo-900 font-bold flex items-center mr-2 mb-1" title="Qayta topshirishga ruxsat berish">
                        üîÑ Qayta topshirish
                    </button>` : ''}
                    
                    ${(currentUser && currentUser.role === 'admin') ?
                    `<button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900 flex items-center" title="O'chirish">
                        üóëÔ∏è O'chirish
                    </button>` : ''}
                    
                    ${(!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'dean')) ? '<span class="text-gray-400">-</span>' : ''}
                 </td>
    `
        },
        'log_system': {
            title: 'Tizim Loglari',
            api: '/api/logs/',
            readOnly: true,
            columns: ['Vaqt', 'Foydalanuvchi', 'IP Manzil', 'Action', 'Batafsil'],
            render: (item) => `
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm whitespace-nowrap">${new Date(item.timestamp).toLocaleString()}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm font-bold">${item.user_details ? (item.user_details.full_name || item.user_details.username) : (item.user || '-')}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-gray-500">${item.ip_address || '-'}</td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                   <span class="px-2 py-1 rounded text-xs font-semibold bg-gray-100 text-gray-800 border border-gray-200">${item.action}</span>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                   <div class="text-xs text-gray-500 truncate max-w-xs" title="${item.details}">${item.details}</div>
                </td>
    `
        }
    };

    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('access_token');
        if (!token) { window.location.href = '/login/'; return; }

        config = CONFIGS[PAGE];
        if (!config) { alert('Page configuration not found'); return; }

        document.getElementById('page-title').textContent = config.title;

        // Archive Link Button
        if (PAGE === 'tests') {
            const headerActions = document.querySelector('header .flex.space-x-4');
            const archiveBtn = document.createElement('a');
            archiveBtn.href = '/tests/archive/';
            archiveBtn.className = 'bg-gray-500 text-white px-4 py-2 rounded text-sm hover:bg-gray-600 transition flex items-center';
            archiveBtn.innerHTML = 'üóÑÔ∏è Arxiv';
            archiveBtn.style.marginRight = '10px';
            // Insert before create button
            const createBtn = document.getElementById('create-btn');
            headerActions.insertBefore(archiveBtn, createBtn);
        }

        if (PAGE === 'archived_tests') {
            // Hide Create Button
            const createBtn = document.getElementById('create-btn');
            if (createBtn) createBtn.classList.add('hidden');

            // Add Back Button
            const headerActions = document.querySelector('header .flex.space-x-4');
            const backBtn = document.createElement('a');
            backBtn.href = '/tests/';
            backBtn.className = 'bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition flex items-center';
            backBtn.innerHTML = '‚¨ÖÔ∏è Testlarga qaytish';
            backBtn.style.marginRight = '10px';

            if (createBtn) headerActions.insertBefore(backBtn, createBtn);
            else headerActions.appendChild(backBtn);
        }



        // Setup Search
        let searchTimeout;
        window.handleSearch = (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadData(token), 500); // Removed inline params, now using dom
        };

        // Setup Filters
        const filterContainer = document.getElementById('filter-container');
        if (PAGE === 'groups' || PAGE === 'students') {
            filterContainer.classList.remove('hidden');

            // Course Filter
            const courseSelect = document.createElement('select');
            courseSelect.id = 'filter-course';
            courseSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
            courseSelect.innerHTML = '<option value="">Kurs bo\'yicha</option>' +
                [1, 2, 3, 4].map(c => `<option value="${c}">${c}-kurs</option>`).join('');
            if (PAGE !== 'students') {
                courseSelect.onchange = () => loadData(token);
            }
            filterContainer.appendChild(courseSelect);

            // Direction Filter
            const dirSelect = document.createElement('select');
            dirSelect.id = 'filter-direction';
            dirSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
            dirSelect.innerHTML = '<option value="">Yo\'nalish bo\'yicha</option>';

            // Fetch directions
            axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token} ` } })
                .then(res => {
                    const directions = res.data.results || res.data;
                    directions.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.name;
                        opt.textContent = d.name;
                        dirSelect.appendChild(opt);
                    });
                });
            dirSelect.onchange = () => {
                if (PAGE !== 'students') loadData(token);
            };
            filterContainer.appendChild(dirSelect);
        }

        if (PAGE === 'students') {
            // Education Form Filter
            const eduSelect = document.createElement('select');
            eduSelect.id = 'filter-edu-form';
            eduSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
            eduSelect.innerHTML = '<option value="">Ta\'lim shakli</option>' +
                '<option value="kunduzgi">Kunduzgi</option>' +
                '<option value="sirtqi">Sirtqi</option>' +
                '<option value="kechki">Kechki</option>';
            eduSelect.onchange = () => loadData(token);
            filterContainer.appendChild(eduSelect);

            // Group Filter (Dependent)
            const groupSelect = document.createElement('select');
            groupSelect.id = 'filter-group';
            groupSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
            groupSelect.innerHTML = '<option value="">Guruh bo\'yicha</option>';
            filterContainer.appendChild(groupSelect);

            // Fetch groups for filter and setup dependency
            let allFilterGroups = [];

            const updateGroupOptions = () => {
                const courseVal = document.getElementById('filter-course').value;
                const dirVal = document.getElementById('filter-direction').value;

                let filtered = allFilterGroups;

                if (courseVal) {
                    filtered = filtered.filter(g => g.course == courseVal);
                }

                if (dirVal) {
                    // Robust check: remove extra spaces, lowercase match if needed, handle potential ID vs Name mismatch
                    const target = dirVal.trim().toLowerCase();
                    filtered = filtered.filter(g => {
                        const gDir = (g.direction || '').toString().trim().toLowerCase();
                        const gDirName = (g.direction_name || '').toString().trim().toLowerCase();
                        return gDir === target || gDirName === target;
                    });
                }

                groupSelect.innerHTML = '<option value="">Guruh bo\'yicha</option>' +
                    filtered.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            };

            axios.get('/api/groups/?page_size=1000', { headers: { Authorization: `Bearer ${token} ` } })
                .then(res => {
                    // Handle paginated response
                    allFilterGroups = res.data.results || res.data;
                    updateGroupOptions(); // Initial populate
                });

            // Attach listeners to course and direction for dependency
            document.getElementById('filter-course').addEventListener('change', () => {
                updateGroupOptions();
                loadData(token);
            });
            document.getElementById('filter-direction').addEventListener('change', () => {
                updateGroupOptions();
                loadData(token);
            });

            groupSelect.onchange = () => loadData(token);
        }




        if (PAGE === 'tests' || PAGE === 'archived_tests') {
            filterContainer.classList.remove('hidden');

            // Direction Filter
            const dirSelect = document.createElement('select');
            dirSelect.id = 'filter-direction';
            dirSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
            dirSelect.innerHTML = '<option value="">Yo\'nalish bo\'yicha</option>';
            filterContainer.appendChild(dirSelect);

            // Subject Filter
            const subjectSelect = document.createElement('select');
            subjectSelect.id = 'filter-subject';
            subjectSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
            subjectSelect.innerHTML = '<option value="">Fan bo\'yicha</option>';
            subjectSelect.onchange = () => loadData(token);
            filterContainer.appendChild(subjectSelect);

            // Group Filter
            const groupSelect = document.createElement('select');
            groupSelect.id = 'filter-group';
            groupSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
            groupSelect.innerHTML = '<option value="">Biriktirilgan Guruh bo\'yicha</option>';
            groupSelect.onchange = () => loadData(token);
            filterContainer.appendChild(groupSelect);

            let allGroups = [];

            // Fetch Directions
            axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } })
                .then(res => {
                    const directions = res.data.results || res.data;
                    directions.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.name; // Filter by Name 
                        opt.textContent = d.name;
                        dirSelect.appendChild(opt);
                    });
                }).catch(e => console.error(e));

            dirSelect.onchange = () => {
                const selectedDir = dirSelect.value;
                // Filter group options
                groupSelect.innerHTML = '<option value="">Biriktirilgan Guruh bo\'yicha</option>';

                const filteredGroups = selectedDir
                    ? allGroups.filter(g => g.direction === selectedDir || g.direction_name === selectedDir)
                    : allGroups;

                filteredGroups.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    groupSelect.appendChild(opt);
                });
                loadData(token);
            };

            // Fetch Subjects
            axios.get('/api/subjects/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } })
                .then(res => {
                    const subjects = res.data.results || res.data;
                    subjects.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        subjectSelect.appendChild(opt);
                    });
                }).catch(e => console.error(e));

            // Fetch All Groups
            axios.get('/api/groups/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } })
                .then(res => {
                    allGroups = res.data.results || res.data;
                    // Initial populate
                    allGroups.forEach(g => {
                        const opt = document.createElement('option');
                        opt.value = g.id;
                        opt.textContent = g.name;
                        groupSelect.appendChild(opt);
                    });
                }).catch(e => console.error(e));
        }

        // Setup Save
        document.getElementById('saveBtn').onclick = () => saveItem(token);

        // Initial Load
        try {
            // Fetch User Profile for Sidebar logic
            const userRes = await axios.get('/api/accounts/profile/', { headers: { Authorization: `Bearer ${token} ` } });

            const user = userRes.data;
            currentUser = user; // Set global user

            // --- PERMISSION CHECKS (Must be after user load) ---

            // 1. Create Button Permission
            const createBtn = document.getElementById('create-btn');
            let canCreate = false;
            if (currentUser.role === 'admin') {
                canCreate = true;
            } else if (currentUser.permissions) {
                const perm = currentUser.permissions.find(p => p.module === PAGE);
                if (perm && perm.can_create) canCreate = true;
            }

            if (config.readOnly || !canCreate) {
                createBtn.classList.add('hidden');
            } else {
                createBtn.classList.remove('hidden');
            }

            // 2. Import Button Logic
            if (config.importApi) {
                let canImport = false;
                if (currentUser.role === 'admin') canImport = true;
                else if (currentUser.permissions) {
                    const perm = currentUser.permissions.find(p => p.module === PAGE);
                    if (perm && perm.can_export) canImport = true;
                }

                if (canImport) {
                    const header = document.querySelector('header .flex');
                    if (!document.getElementById('import-btn-dynamic')) {
                        const importBtn = document.createElement('button');
                        importBtn.id = 'import-btn-dynamic';
                        importBtn.className = 'bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition ml-2';
                        importBtn.innerHTML = 'üì• Import (Excel)';
                        importBtn.onclick = openImportModal;
                        header.appendChild(importBtn);
                    }
                }
            }

            // --- RESULTS FILTERS ---
            if (PAGE === 'results') {
                filterContainer.classList.remove('hidden');

                // 1. Test Filter
                const testSelect = document.createElement('select');
                testSelect.id = 'filter-test';
                testSelect.className = 'border rounded px-3 py-1 text-sm mr-2 w-48';
                testSelect.innerHTML = '<option value="">Test bo\'yicha</option>';
                filterContainer.appendChild(testSelect);

                axios.get('/api/tests/', { headers: { Authorization: `Bearer ${token} ` } })
                    .then(res => {
                        const tests = res.data.results || res.data;
                        tests.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t.id;
                            opt.textContent = t.title;
                            testSelect.appendChild(opt);
                        });
                    });
                testSelect.onchange = () => loadData(token);

                // 2. Course Filter
                const courseSelect = document.createElement('select');
                courseSelect.id = 'filter-results-course';
                courseSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
                courseSelect.innerHTML = '<option value="">Kurs</option>' + [1, 2, 3, 4].map(c => `<option value="${c}">${c}</option>`).join('');
                filterContainer.appendChild(courseSelect);

                // 3. Edu Form Filter
                const eduSelect = document.createElement('select');
                eduSelect.id = 'filter-results-edu';
                eduSelect.className = 'border rounded px-3 py-1 text-sm mr-2 w-24';
                eduSelect.innerHTML = `<option value="">Ta'lim</option><option value="kunduzgi">Kunduzgi</option><option value="sirtqi">Sirtqi</option><option value="kechki">Kechki</option>`;
                filterContainer.appendChild(eduSelect);

                // 4. Direction Filter
                const dirSelect = document.createElement('select');
                dirSelect.id = 'filter-results-dir';
                dirSelect.className = 'border rounded px-3 py-1 text-sm mr-2 w-32';
                dirSelect.innerHTML = '<option value="">Yo\'nalish</option>';
                filterContainer.appendChild(dirSelect);

                axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } })
                    .then(res => {
                        (res.data.results || res.data).forEach(d => {
                            dirSelect.innerHTML += `<option value="${d.name}">${d.name}</option>`;
                        });
                    });

                // 5. Group Filter (Dependent)
                // Defined before status to match requested order: Test -> Course -> Edu -> Dir -> Group -> Status
                if (currentUser && currentUser.role !== 'student') {
                    const groupSelect = document.createElement('select');
                    groupSelect.id = 'filter-group-results';
                    groupSelect.className = 'border rounded px-3 py-1 text-sm mr-2 w-32';
                    groupSelect.innerHTML = '<option value="">Guruh bo\'yicha</option>';
                    filterContainer.appendChild(groupSelect);

                    let allResultGroups = [];

                    const updateResultGroupOptions = () => {
                        const courseVal = courseSelect.value;
                        const eduVal = eduSelect.value;
                        const dirVal = dirSelect.value;

                        let filtered = allResultGroups;

                        if (courseVal) {
                            filtered = filtered.filter(g => g.course == courseVal);
                        }
                        if (eduVal) {
                            // Edu form in group might be strict match, make it robust
                            const targetEdu = eduVal.trim().toLowerCase();
                            filtered = filtered.filter(g => {
                                const gEdu = (g.education_form || '').toString().trim().toLowerCase();
                                return gEdu === targetEdu;
                            });
                        }
                        if (dirVal) {
                            const target = dirVal.trim().toLowerCase();
                            filtered = filtered.filter(g => {
                                const gDir = (g.direction || '').toString().trim().toLowerCase();
                                const gDirName = (g.direction_name || '').toString().trim().toLowerCase();
                                return gDir === target || gDirName === target;
                            });
                        }

                        groupSelect.innerHTML = '<option value="">Guruh bo\'yicha</option>' +
                            filtered.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                    };

                    axios.get('/api/groups/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } })
                        .then(res => {
                            allResultGroups = res.data.results || res.data;
                            updateResultGroupOptions();
                        });

                    // Attach Dependency Listeners
                    courseSelect.onchange = () => { updateResultGroupOptions(); loadData(token); };
                    eduSelect.onchange = () => { updateResultGroupOptions(); loadData(token); };
                    dirSelect.onchange = () => { updateResultGroupOptions(); loadData(token); };
                    groupSelect.onchange = () => loadData(token);
                } else {
                    // For student/others if logic needed, or just attach listeners to others if group not present
                    courseSelect.onchange = () => loadData(token);
                    eduSelect.onchange = () => loadData(token);
                    dirSelect.onchange = () => loadData(token);
                }

                // 6. Status Filter
                const statusSelect = document.createElement('select');
                statusSelect.id = 'filter-status';
                statusSelect.className = 'border rounded px-3 py-1 text-sm mr-2';
                statusSelect.innerHTML = `<option value="">Holat bo'yicha</option><option value="passed">O'tgan (Passed)</option><option value="failed">O'tmagan (Failed)</option>`;
                statusSelect.onchange = () => loadData(token);
                filterContainer.appendChild(statusSelect);

                // Date Filters
                const startInp = document.createElement('input');
                startInp.type = 'date';
                startInp.id = 'filter-start-date';
                startInp.className = 'border rounded px-3 py-1 text-sm mr-2';
                startInp.onchange = () => loadData(token);
                filterContainer.appendChild(startInp);

                const endInp = document.createElement('input');
                endInp.type = 'date';
                endInp.id = 'filter-end-date';
                endInp.className = 'border rounded px-3 py-1 text-sm mr-2';
                endInp.onchange = () => loadData(token);
                filterContainer.appendChild(endInp);


                // 7. Export Buttons (Admin only)
                if (currentUser && currentUser.role !== 'student') {
                    const exportBtn = document.createElement('button');
                    exportBtn.textContent = 'Excelga Yuklash';
                    exportBtn.className = 'bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700';
                    exportBtn.onclick = async () => {
                        const test = document.getElementById('filter-test').value;
                        const group = document.getElementById('filter-group-results') ? document.getElementById('filter-group-results').value : '';
                        const statusVal = document.getElementById('filter-status').value;
                        const search = document.getElementById('searchInput').value;
                        const course = document.getElementById('filter-results-course').value;
                        const edu = document.getElementById('filter-results-edu').value;
                        const dir = document.getElementById('filter-results-dir').value;
                        const start = document.getElementById('filter-start-date').value;
                        const end = document.getElementById('filter-end-date').value;

                        const url = `/api/results/export_excel/?test=${test}&student__group=${group}&status=${statusVal}&search=${search}&course=${course}&education_form=${edu}&direction=${dir}&start_date=${start}&end_date=${end}`;

                        try {
                            exportBtn.textContent = 'Yuklanmoqda...';
                            exportBtn.disabled = true;

                            const response = await axios.get(url, {
                                headers: { Authorization: `Bearer ${token}` },
                                responseType: 'blob'
                            });

                            // Create download link
                            const downloadUrl = window.URL.createObjectURL(new Blob([response.data]));
                            const link = document.createElement('a');
                            link.href = downloadUrl;
                            link.setAttribute('download', 'natijalar.xlsx');
                            document.body.appendChild(link);
                            link.click();
                            link.remove();
                        } catch (e) {
                            console.error(e);
                            alert('Yuklashda xatolik: ' + (e.response?.status === 401 ? 'Avtorizatsiya xatosi' : 'Noma\'lum xatolik'));
                        } finally {
                            exportBtn.textContent = 'Excelga Yuklash';
                            exportBtn.disabled = false;
                        }
                    };
                    filterContainer.appendChild(exportBtn);

                    // 8. Export Vedmost (Docx) Button
                    const exportDocxBtn = document.createElement('button');
                    exportDocxBtn.textContent = 'Vedmost (Docx)';
                    exportDocxBtn.className = 'bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 ml-2';
                    exportDocxBtn.onclick = async () => {
                        // Reuse filters
                        const test = document.getElementById('filter-test').value;
                        const group = document.getElementById('filter-group-results') ? document.getElementById('filter-group-results').value : '';
                        const statusVal = document.getElementById('filter-status').value;
                        const search = document.getElementById('searchInput').value;
                        const course = document.getElementById('filter-results-course').value;
                        const edu = document.getElementById('filter-results-edu').value;
                        const dir = document.getElementById('filter-results-dir').value;
                        const start = document.getElementById('filter-start-date').value;
                        const end = document.getElementById('filter-end-date').value;

                        const url = `/api/results/export_docx/?test=${test}&student__group=${group}&status=${statusVal}&search=${search}&course=${course}&education_form=${edu}&direction=${dir}&start_date=${start}&end_date=${end}`;

                        try {
                            exportDocxBtn.textContent = 'Yuklanmoqda...';
                            exportDocxBtn.disabled = true;

                            const response = await axios.get(url, {
                                headers: { Authorization: `Bearer ${token}` },
                                responseType: 'blob'
                            });

                            const downloadUrl = window.URL.createObjectURL(new Blob([response.data]));
                            const link = document.createElement('a');
                            link.href = downloadUrl;
                            link.setAttribute('download', 'natijalar_vedmost.docx');
                            document.body.appendChild(link);
                            link.click();
                            link.remove();
                        } catch (e) {
                            console.error(e);
                            alert('Yuklashda xatolik (Docx)');
                        } finally {
                            exportDocxBtn.textContent = 'Vedmost (Docx)';
                            exportDocxBtn.disabled = false;
                        }
                    };
                    filterContainer.appendChild(exportDocxBtn);
                }
            }

            // Sidebar Logic based on Permissions
            if (user.role === 'admin') {
                // Admin sees everything
                ['dashboard', 'monitoring', 'groups', 'students', 'results', 'vedmost', 'directions', 'subjects', 'tests', 'employees', 'log_system'].forEach(m => {
                    const el = document.getElementById(`menu-${m}`);
                    if (el) el.classList.remove('hidden');
                });
            } else {
                // Check granular permissions
                if (user.permissions && Array.isArray(user.permissions)) {
                    user.permissions.forEach(p => {
                        if (p.can_view && p.module) {
                            const el = document.getElementById(`menu-${p.module}`);
                            if (el) el.classList.remove('hidden');
                        }
                    });
                }

                // Student specific overrides (if not covered by permissions yet)
                if (user.role === 'student') {
                    const resMenu = document.getElementById('menu-results');
                    if (resMenu) resMenu.classList.remove('hidden');
                }
            }

            // Update Sidebar Profile Info
            document.getElementById('user-name').textContent = user.last_name + ' ' + user.first_name.charAt(0) + '.';
            document.getElementById('user-role').textContent = user.role;
            document.getElementById('user-avatar').textContent = (user.first_name || user.username).charAt(0).toUpperCase();

        } catch (e) { console.error("User profile fetch failed", e); }

        loadData(token);
    });

    // Global Pagination State
    let currentPage = 1;
    let pageSize = 20;
    let currentOrder = ''; // Sorting state

    // Toggle Sort Function
    window.toggleSort = (field) => {
        if (field !== 'full_name') return; // Only support full_name for now

        if (currentOrder === 'full_name') currentOrder = '-full_name';
        else if (currentOrder === '-full_name') currentOrder = '';
        else currentOrder = 'full_name'; // Default start A-Z

        loadData(localStorage.getItem('access_token'), 1); // Reset to page 1
    };

    async function allowRetake(id) {
        showModal(
            'Qayta topshirish',
            'Haqiqatan ham ushbu talabaga testni qayta topshirishga ruxsat bermoqchimisiz? Eski natija saqlanib qoladi.',
            async () => {
                const token = localStorage.getItem('access_token');
                try {
                    await axios.post(`${CONFIGS[PAGE].api}${id}/allow_retake/`, {}, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadData(token);
                    showModal('Muvaffaqiyatli', 'Qayta topshirishga ruxsat berildi!');
                } catch (error) {
                    console.error(error);
                    showModal('Xatolik', 'Xatolik yuz berdi');
                }
            }
        );
    }

    async function loadData(token, page = 1) {
        try {
            document.getElementById('loading').classList.remove('hidden');
            const search = document.getElementById('searchInput').value;
            pageSize = document.getElementById('page-size-select') ? document.getElementById('page-size-select').value : 50;

            const params = { search };

            // Only send pagination params if page supports it (students, results, subjects, directions, employees, tests)
            if (['students', 'results', 'subjects', 'directions', 'employees', 'tests', 'archived_tests'].includes(PAGE)) {
                params.page = page;
                params.page_size = pageSize;
            }

            // Add filters if present
            const courseFilter = document.getElementById('filter-course');
            const dirFilter = document.getElementById('filter-direction');
            const eduFilter = document.getElementById('filter-edu-form');
            const groupFilter = document.getElementById('filter-group');

            const subjectFilter = document.getElementById('filter-subject');

            if (courseFilter && courseFilter.value) params.course = courseFilter.value;
            if (dirFilter && dirFilter.value) params.direction = dirFilter.value;
            if (eduFilter && eduFilter.value) params.education_form = eduFilter.value;
            if (groupFilter && groupFilter.value) params.group = groupFilter.value;
            if (subjectFilter && subjectFilter.value) params.subject = subjectFilter.value;

            // Result Filters
            const testFilter = document.getElementById('filter-test');
            const groupResultsFilter = document.getElementById('filter-group-results');
            const statusFilter = document.getElementById('filter-status');

            if (testFilter && testFilter.value) params.test = testFilter.value;
            if (groupResultsFilter && groupResultsFilter.value) params.student__group = groupResultsFilter.value;
            if (statusFilter && statusFilter.value) params.status = statusFilter.value;

            // Result Extended Filters
            const rCourse = document.getElementById('filter-results-course');
            const rEdu = document.getElementById('filter-results-edu');
            const rDir = document.getElementById('filter-results-dir');
            const rStart = document.getElementById('filter-start-date');
            const rEnd = document.getElementById('filter-end-date');

            if (rCourse && rCourse.value) params.course = rCourse.value;
            if (rEdu && rEdu.value) params.education_form = rEdu.value;
            if (rDir && rDir.value) params.direction = rDir.value;
            if (rStart && rStart.value) params.start_date = rStart.value;
            if (rEnd && rEnd.value) params.end_date = rEnd.value;

            // Add Ordering
            if (currentOrder) params.ordering = currentOrder;

            const res = await axios.get(config.api, { headers: { Authorization: `Bearer ${token}` }, params });

            // Handle Pagination vs List
            let data = res.data;
            if (data.results && Array.isArray(data.results)) {
                // Paginated Response
                renderTable(data.results);
                setupPagination(data.count, page, pageSize);
            } else {
                // Plain List
                renderTable(data);
                document.getElementById('pagination-controls').classList.add('hidden');
            }

            document.getElementById('loading').classList.add('hidden');
        } catch (e) {
            console.error(e);
            document.getElementById('loading').textContent = 'Xatolik yuz berdi';
        }
    }

    function setupPagination(totalCount, page, size) {
        const controls = document.getElementById('pagination-controls');
        if (!controls) return;

        controls.classList.remove('hidden');
        currentPage = page;

        const totalPages = Math.ceil(totalCount / size);

        // Update Info Text
        const start = (page - 1) * size + 1;
        const end = Math.min(page * size, totalCount);
        document.getElementById('page-start').textContent = start;
        document.getElementById('page-end').textContent = end;
        document.getElementById('total-count').textContent = totalCount;
        document.getElementById('current-page-display').textContent = page;

        // Update Buttons
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');

        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= totalPages;

        // Button Handlers
        prevBtn.onclick = () => {
            if (page > 1) loadData(localStorage.getItem('access_token'), page - 1);
        };
        nextBtn.onclick = () => {
            if (page < totalPages) loadData(localStorage.getItem('access_token'), page + 1);
        };

        // Page Size Handler (Global listener setup once, or inline here safely)
        const sizeSelect = document.getElementById('page-size-select');
        sizeSelect.onchange = () => {
            loadData(localStorage.getItem('access_token'), 1); // Reset to page 1 on size change
        };
    }

    function renderTable(data) {
        document.getElementById('table-head').innerHTML = config.columns.map((c, index) => {
            // Check if column is sortable (Student F.I.SH)
            if (PAGE === 'students' && c === 'F.I.SH') {
                let icon = '';
                if (currentOrder === 'full_name') icon = ' üîº';
                if (currentOrder === '-full_name') icon = ' üîΩ';
                return `<th onclick="toggleSort('full_name')" class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200 select-none">${c}${icon}</th>`;
            }

            // Hide Checkbox Header for Students in Results
            if (PAGE === 'results' && index === 0 && currentUser && currentUser.role === 'student') {
                return `<th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"></th>`;
            }

            return `<th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${c}</th>`;
        }).join('');

        const tbody = document.getElementById('table-body');
        if (data.length === 0) tbody.innerHTML = '<tr><td colspan="100" class="p-4 text-center">Ma\'lumotlar yuq.</td></tr>';
        else tbody.innerHTML = data.map(item => `<tr>${config.render(item)}</tr>`).join('');
        document.getElementById('loading').classList.add('hidden');
    }

    // CRUD ACTIONS
    window.openCreateModal = async () => {
        if (PAGE === 'employees') {
            openEmployeeModal();
            return;
        }

        currentId = null;
        document.getElementById('modalTitle').textContent = `Yangi ${config.title} qo'shish`;

        // Dynamic Options Fetching for Groups
        if (PAGE === 'groups') {
            const token = localStorage.getItem('access_token');
            try {
                const res = await axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } });
                const directions = res.data.results || res.data;
                const directionField = config.fields.find(f => f.name === 'direction');
                if (directionField) {
                    directionField.type = 'select'; // Ensure it's select
                    directionField.options = directions.map(d => ({ val: d.name, text: `${d.name} (${d.code})` }));
                }
            } catch (e) { console.error('Error fetching directions', e); }
        }

        // Dynamic Options Fetching for Subjects
        if (PAGE === 'subjects') {
            const token = localStorage.getItem('access_token');
            try {
                const [dirRes, empRes] = await Promise.all([
                    axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } }),
                    axios.get('/api/employees/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } })
                ]);

                // Directions
                const directions = dirRes.data.results || dirRes.data;
                const directionField = config.fields.find(f => f.name === 'directions');
                if (directionField) {
                    directionField.type = 'select';
                    directionField.options = directions.map(d => ({ val: d.name, text: `${d.name} (${d.code})` }));
                }

                // Teachers
                const teacherField = config.fields.find(f => f.name === 'teacher');
                if (teacherField) {
                    teacherField.type = 'select';
                    // Filter mainly teachers if needed, but admins can be assigned too? 
                    // Let's show all employees but mark role in text.
                    // Assuming API returns list of users
                    const employees = empRes.data.results || empRes.data;
                    teacherField.options = [{ val: '', text: 'O\'qituvchi tanlang...' }].concat(
                        employees.map(u => ({
                            val: u.id,
                            text: `${u.first_name || ''} ${u.last_name || ''} (${u.username}) - ${u.role}`.trim()
                        }))
                    );
                }

            } catch (e) { console.error('Error fetching data for subjects', e); }
        }

        // Dynamic Options Fetching for Students
        if (PAGE === 'students') {
            const token = localStorage.getItem('access_token');
            try {
                // Fetch Groups and Directions
                const [groupRes, dirRes] = await Promise.all([
                    axios.get('/api/groups/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } }),
                    axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } })
                ]);

                const allGroups = groupRes.data.results || groupRes.data;
                const allDirections = dirRes.data.results || dirRes.data;
                window.allGroupsData = allGroups;

                // Shared Filter Logic
                const filterGroups = () => {
                    const courseInput = document.getElementById('field-course');
                    const dirInput = document.getElementById('field-direction');
                    const groupSelect = document.getElementById('field-group');

                    if (!courseInput || !dirInput || !groupSelect) return;

                    const selectedCourse = parseInt(courseInput.value);
                    const selectedDir = dirInput.value;

                    let filteredGroups = allGroups;

                    if (selectedDir) {
                        filteredGroups = filteredGroups.filter(g => g.direction === selectedDir);
                    }
                    if (selectedCourse) {
                        filteredGroups = filteredGroups.filter(g => g.course === selectedCourse);
                    }

                    if (filteredGroups.length > 0) {
                        groupSelect.innerHTML = '<option value="">Guruhni tanlang</option>' +
                            filteredGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                    } else {
                        groupSelect.innerHTML = '<option value="">Mos guruhlar topilmadi</option>';
                    }
                };

                // Setup Direction Field
                const directionField = config.fields.find(f => f.name === 'direction');
                if (directionField) {
                    directionField.type = 'select';
                    directionField.options = allDirections.map(d => ({ val: d.name, text: `${d.name} (${d.code})` }));
                    directionField.onChange = filterGroups;
                }

                // Setup Course Field
                const courseField = config.fields.find(f => f.name === 'course');
                if (courseField) {
                    courseField.onChange = filterGroups;
                }

                // Setup Group Field (Empty initially)
                const groupField = config.fields.find(f => f.name === 'group');
                if (groupField) {
                    groupField.type = 'select';
                    groupField.options = [{ val: '', text: 'Avval yo\'nalish va kursni tanlang' }];
                }

            } catch (e) { console.error('Error fetching data for student form', e); }
        }

        renderForm();

        // Post-render listener attachment
        if (PAGE === 'students') {
            const dirSelect = document.getElementById('field-direction');
            const courseInput = document.getElementById('field-course');

            if (dirSelect) dirSelect.addEventListener('change', () => {
                const dirField = config.fields.find(f => f.name === 'direction');
                if (dirField && dirField.onChange) dirField.onChange();
            });

            if (courseInput) courseInput.addEventListener('input', () => {
                const courseField = config.fields.find(f => f.name === 'course');
                if (courseField && courseField.onChange) courseField.onChange();
            });
        }

        document.getElementById('crudModal').classList.remove('hidden');
    }

    window.editItem = async (id) => {
        if (PAGE === 'employees') {
            openEmployeeModal(id);
            return;
        }
        currentId = id;
        document.getElementById('modalTitle').textContent = `${config.title} Tahrirlash`;
        const token = localStorage.getItem('access_token');
        try {
            // Fetch item data
            const res = await axios.get(`${config.api}${id}/`, { headers: { Authorization: `Bearer ${token}` } });

            // Dynamic Options Fetching for Groups (Edit Mode)
            if (PAGE === 'groups') {
                try {
                    const dirRes = await axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } });
                    const directions = dirRes.data.results || dirRes.data;
                    // DEBUG: Remove in production
                    // alert(`Debug: Yuklangan yo'nalishlar soni: ${directions.length}. Talabada: ${res.data.direction}`);

                    const directionField = config.fields.find(f => f.name === 'direction');
                    if (directionField) {
                        directionField.type = 'select';
                        directionField.options = directions.map(d => ({ val: d.name, text: `${d.name} (${d.code})` }));

                        // Fallback check: if current val is not in options, maybe add it as custom option or warn?
                        // For now just ensuring options are there.
                    }
                } catch (e) { console.error('Error fetching directions', e); }
            }

            // Dynamic Options Fetching for Subjects (Edit Mode)
            if (PAGE === 'subjects') {
                try {
                    const [dirRes, empRes] = await Promise.all([
                        axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } }),
                        axios.get('/api/employees/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } })
                    ]);

                    const directions = dirRes.data.results || dirRes.data;
                    const directionField = config.fields.find(f => f.name === 'directions');
                    if (directionField) {
                        directionField.type = 'select';
                        directionField.options = directions.map(d => ({ val: d.name, text: `${d.name} (${d.code})` }));
                    }

                    const teacherField = config.fields.find(f => f.name === 'teacher');
                    if (teacherField) {
                        teacherField.type = 'select';
                        const employees = empRes.data.results || empRes.data;
                        teacherField.options = [{ val: '', text: 'O\'qituvchi tanlang...' }].concat(
                            employees.map(u => ({
                                val: u.id,
                                text: `${u.first_name || ''} ${u.last_name || ''} (${u.username}) - ${u.role}`.trim()
                            }))
                        );
                    }
                } catch (e) { console.error('Error fetching data for subjects', e); }
            }

            // Dynamic Options Fetching for Students (Edit Mode)
            if (PAGE === 'students') {
                try {
                    // Fetch Groups
                    const groupRes = await axios.get('/api/groups/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } });
                    const groupsData = groupRes.data.results || groupRes.data;
                    const groupField = config.fields.find(f => f.name === 'group');
                    if (groupField) {
                        groupField.type = 'select';
                        groupField.options = groupsData.map(g => ({ val: g.id, text: g.name }));
                    }

                    // Fetch Directions
                    const dirRes = await axios.get('/api/directions/?page_size=1000', { headers: { Authorization: `Bearer ${token}` } });
                    const directions = dirRes.data.results || dirRes.data;
                    const directionField = config.fields.find(f => f.name === 'direction');
                    if (directionField) {
                        directionField.type = 'select'; // Enforce select type
                        directionField.options = directions.map(d => ({ val: d.name, text: `${d.name} (${d.code})` }));
                    }

                    // Pre-populate group based on current student data
                    if (res.data.group) {
                        // Ensure groups are loaded or we might need to fetch them if not already done by page logic
                        // But usually we just fetch all groups for simplicity in small apps, or filter.
                        // Let's re-use the same logic as Create Mode: fetch all groups
                        // Already done above in 'groupRes'
                    }

                } catch (e) { console.error('Error fetching data for student form', e); }
            }

            renderForm(res.data);

            // Post-render logic for Students to attach listeners (Re-attach for Edit mode too)
            if (PAGE === 'students') {
                // We need to re-bind the filter logic if we want changing direction to update groups
                // ... (Logic similar to Create Mode, maybe refactor to shared function later)
                const dirSelect = document.getElementById('field-direction');
                const courseInput = document.getElementById('field-course');
                // Re-define filterGroups if scope issue or just rely on global window.allGroupsData if set

                // Ideally we should extract the detailed setup logic from openCreateModal to a helper 'setupStudentForm()'
                // For now, let's just make sure the Directions dropdown is populated (which we did above).
            }

            document.getElementById('crudModal').classList.remove('hidden');
        } catch (e) {
            console.error(e);
            alert('Error loading item: ' + e.message);
        }
    }

    window.closeCrudModal = () => {
        document.getElementById('crudModal').classList.add('hidden');
    }



    window.toggleStudentStatus = (id, currentStatus) => {
        const msg = currentStatus ? "Talabaning tizimga kirishini bloklashni xohlaysizmi?" : "Talabaning tizimga kirishiga ruxsat berasizmi?";
        showModal('Tasdiqlash', msg, async () => {
            const token = localStorage.getItem('access_token');
            try {
                await axios.patch(`${config.api}${id}/`,
                    { is_system_active: !currentStatus },
                    { headers: { Authorization: `Bearer ${token}` } }
                );
                loadData(token);
            } catch (e) {
                console.error(e);
                showModal('Xatolik', 'Holatni o\'zgartirishda xatolik yuz berdi');
            }
        });
    }

    window.toggleGroupStatus = (id, currentStatus) => {
        const msg = currentStatus
            ? "Guruhni nofaol qilmoqchimisiz? Bu guruhdagi barcha talabalar tizimga kira olmaydi!"
            : "Guruhni faollashtirmoqchimisiz?";

        showModal('Tasdiqlash', msg, async () => {
            const token = localStorage.getItem('access_token');
            try {
                await axios.patch(`${config.api}${id}/`,
                    { is_system_active: !currentStatus },
                    { headers: { Authorization: `Bearer ${token}` } }
                );
                loadData(token);
            } catch (e) {
                showModal('Xatolik', 'Holatni o\'zgartirishda xatolik yuz berdi');
            }
        });
    }

    window.deleteItem = (id) => {
        showModal('Tasdiqlash', "Haqiqatan ham o'chirmoqchimisiz?", async () => {
            const token = localStorage.getItem('access_token');
            try {
                await axios.delete(`${config.api}${id}/`, { headers: { Authorization: `Bearer ${token}` } });
                loadData(token, currentPage); // Reload current page
            } catch (error) {
                let msg = 'O\'chirishda xatolik yuz berdi';
                if (error.response && error.response.status === 403 && error.response.data.detail) {
                    msg = error.response.data.detail;
                }
                showModal('Xatolik', msg);
            }
        });
    };

    window.saveItem = async (token) => {
        if (!validateForm(config.fields)) return;

        try {
            // Collect Form Data
            const formData = {};
            config.fields.forEach(field => {
                const el = document.getElementById(`field-${field.name}`);
                if (el) {
                    if (field.type === 'checkbox') {
                        formData[field.name] = el.checked;
                    } else if (field.type === 'select' && el.value === "") {
                        // Skip empty select if optional or handle validation
                        // validation handled above
                        formData[field.name] = null;
                    } else {
                        formData[field.name] = el.value;
                    }
                }
            });

            // Special handling for permissions_matrix
            config.fields.forEach(field => {
                if (field.type === 'permissions_matrix') {
                    const permissions = [];
                    field.modules.forEach(mod => {
                        const row = { module: mod.val };
                        let hasAny = false;
                        ['view', 'update', 'create', 'delete', 'export'].forEach(action => {
                            const cb = document.getElementById(`perm-${mod.val}-${action}`);
                            if (cb && cb.checked) {
                                row[`can_${action}`] = true;
                                hasAny = true;
                            } else {
                                row[`can_${action}`] = false;
                            }
                        });
                        if (hasAny) permissions.push(row);
                    });
                    formData['module_accesses'] = permissions;
                }
            });

            // Default Role for Employees if removed from UI
            if (PAGE === 'employees' && !formData.role) {
                formData.role = 'teacher'; // Default to teacher so they appear in list (not student)
            }

            // Special handling for Test dates formatting if needed
            // Django expects ISO format, datetime-local provides 'YYYY-MM-DDTHH:mm' which works mostly.

            if (currentId) {
                await axios.patch(`${config.api}${currentId}/`, formData, { headers: { Authorization: `Bearer ${token}` } });
            } else {
                await axios.post(config.api, formData, { headers: { Authorization: `Bearer ${token}` } });
            }
            document.getElementById('crudModal').classList.add('hidden');
            loadData(token, currentPage); // Reload
        } catch (error) {
            console.error(error);
            let msg = 'Saqlashda xatolik yuz berdi';
            if (error.response && error.response.data) {
                if (error.response.status === 403 && error.response.data.detail) {
                    msg = error.response.data.detail;
                } else {
                    msg = JSON.stringify(error.response.data);
                }
            }
            showModal('Xatolik', msg);
        }
    };

    // Helper: Form Validation
    function validateForm(fields) {
        for (let field of fields) {
            const el = document.getElementById(`field-${field.name}`);
            // Basic required check (skip password on edit logic handled elsewhere or make robust)
            if (el && field.type !== 'checkbox' && !el.value && field.name !== 'password') { // Password usually optional on edit
                if (currentId && field.name === 'password') continue;
                if (field.name === 'username' && PAGE === 'students' && !el.value) continue; // Optional for students

                showModal('Xatolik', `${field.label} maydoni to'ldirilishi shart`);
                return false;
            }
        }
        return true;
    }

    function renderForm(values = {}) {
        const container = document.getElementById('modalFormContainer');
        container.innerHTML = config.fields.map(f => {
            let val = values[f.name] || '';
            // Datetime fix
            if (f.type === 'datetime-local' && val) val = val.slice(0, 16);

            if (f.type === 'permissions_matrix') {
                const existingPerms = values[f.name] || []; // Array of {module:..., can_view:...}

                const getChecked = (mod, action) => {
                    const found = existingPerms.find(p => p.module === mod);
                    return (found && found[`can_${action}`]) ? 'checked' : '';
                };

                const rows = f.modules.map(mod => `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-4 py-2 text-sm font-medium text-gray-700">${mod.text}</td>
                        <td class="px-4 py-2 text-center"><input type="checkbox" id="perm-${mod.val}-view" ${getChecked(mod.val, 'view')} class="w-4 h-4 text-blue-600 rounded"></td>
                        <td class="px-4 py-2 text-center"><input type="checkbox" id="perm-${mod.val}-update" ${getChecked(mod.val, 'update')} class="w-4 h-4 text-blue-600 rounded"></td>
                        <td class="px-4 py-2 text-center"><input type="checkbox" id="perm-${mod.val}-create" ${getChecked(mod.val, 'create')} class="w-4 h-4 text-blue-600 rounded"></td>
                        <td class="px-4 py-2 text-center"><input type="checkbox" id="perm-${mod.val}-delete" ${getChecked(mod.val, 'delete')} class="w-4 h-4 text-blue-600 rounded"></td>
                        <td class="px-4 py-2 text-center"><input type="checkbox" id="perm-${mod.val}-export" ${getChecked(mod.val, 'export')} class="w-4 h-4 text-blue-600 rounded"></td>
                        <td class="px-4 py-2 text-center"><input type="checkbox" onchange="toggleRow('${mod.val}', this.checked)" class="w-4 h-4 text-indigo-600 rounded"></td>
                    </tr>
                `).join('');

                return `
                <div class="mb-4 text-left">
                    <label class="block text-gray-700 text-sm font-bold mb-2">${f.label}</label>
                    <div class="overflow-x-auto border rounded-lg max-h-64 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200 head-fixed">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Imkoniyatlar</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase">View</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase">Update</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase">Create</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase">Delete</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase">Exp/Imp</th>
                                    <th class="px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase">All</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            if (f.type === 'select') {
                const options = f.options.map(o => `<option value="${o.val}" ${val === o.val ? 'selected' : ''}>${o.text}</option>
`).join('');
                return `
<div class="mb-4 text-left">
    <label class="block text-gray-700 text-sm font-bold mb-2">${f.label}</label>
    <select id="field-${f.name}"
        class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        ${options}
    </select>
</div>`;
            }

            if (f.type === 'checkbox') {
                return `
<div class="mb-4 text-left flex items-center">
    <input type="checkbox" id="field-${f.name}" ${val ? 'checked' : ''}
        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
    <label class="ml-2 block text-gray-700 text-sm font-bold">${f.label}</label>
</div>`;
            }

            return `
<div class="mb-4 text-left">
    <label class="block text-gray-700 text-sm font-bold mb-2">${f.label}</label>
    <input type="${f.type}" id="field-${f.name}" value="${val}" placeholder="${f.placeholder || ''}"
        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
</div>
`}).join('');

        // Add toggle helper global wrapper if not exists
        if (!window.toggleRow) {
            window.toggleRow = (mod, checked) => {
                ['view', 'update', 'create', 'delete', 'export'].forEach(act => {
                    const cb = document.getElementById('perm-' + mod + '-' + act);
                    if (cb) cb.checked = checked;
                });
            };
        }
    }

    let currentImportActionUrl = '';
    let currentSampleUrl = '';

    window.importTestQuestions = (id) => {
        currentImportActionUrl = `/api/tests/${id}/import-questions/`;
        currentSampleUrl = '/api/tests/sample-questions/';
        openImportModal();
    }

    window.openImportModal = () => {
        const modal = document.getElementById('importModal');
        modal.classList.remove('hidden');

        // Reset if simple call
        if (!currentImportActionUrl && config.importApi) currentImportActionUrl = config.importApi;

        // Add sample download link if not exists
        if (!document.getElementById('sample-download-btn')) {
            const container = modal.querySelector('.relative');
            const sampleBtn = document.createElement('a');
            sampleBtn.id = 'sample-download-btn';

            // Determine sample URL based on page or specific action
            let sampleUrl = currentSampleUrl || '';
            if (!sampleUrl && PAGE === 'students') sampleUrl = '/api/students/sample/';

            if (sampleUrl) {
                sampleBtn.href = "#"; // Prevent default nav
                sampleBtn.onclick = async (e) => {
                    e.preventDefault();
                    const token = localStorage.getItem('access_token');
                    try {
                        const response = await axios.get(sampleUrl, {
                            headers: { Authorization: `Bearer ${token}` },
                            responseType: 'blob'
                        });
                        const url = window.URL.createObjectURL(new Blob([response.data]));
                        const link = document.createElement('a');
                        link.href = url;
                        link.setAttribute('download', 'namuna.xlsx'); // File name
                        document.body.appendChild(link);
                        link.click();
                        link.remove();
                    } catch (error) {
                        console.error('Download error:', error);
                        alert("Namuna yuklashda xatolik (Ruxsat yo'q yoki fayl mavjud emas)");
                    }
                };

                sampleBtn.className = "block mt-2 text-center text-blue-600 hover:text-blue-800 text-sm";
                sampleBtn.innerHTML = 'üìã Namuna yuklab olish (.xlsx)';
                const fileInput = document.getElementById('importFile');
                fileInput.parentNode.insertBefore(sampleBtn, fileInput);
            }
        } else if (currentSampleUrl) {
            // Update existing button logic if url changed (simple reload needed ideally, but keeping it simple)
            // For now assuming modal recreation or smart update isn't strictly needed if reload handles it,
            // but here we are in same page SPA-ish.
            // Let's just remove old btn and re-add if we want to be safe, or just update click handler.
            const oldBtn = document.getElementById('sample-download-btn');
            if (oldBtn) oldBtn.remove();
            // Re-call self to add correct btn
            // window.openImportModal(); // Caution: infinite loop risk.

            // DRY violation but safe inline here:
            const container = modal.querySelector('.relative');
            const sampleBtn = document.createElement('a');
            sampleBtn.id = 'sample-download-btn';

            sampleBtn.href = "#";
            sampleBtn.onclick = async (e) => {
                e.preventDefault();
                const token = localStorage.getItem('access_token');
                try {
                    const response = await axios.get(currentSampleUrl, {
                        headers: { Authorization: `Bearer ${token}` },
                        responseType: 'blob'
                    });
                    const url = window.URL.createObjectURL(new Blob([response.data]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', 'namuna.xlsx');
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                } catch (error) {
                    console.error('Download error:', error);
                    alert("Namuna yuklashda xatolik");
                }
            };

            sampleBtn.className = "block mt-2 text-center text-blue-600 hover:text-blue-800 text-sm";
            sampleBtn.innerHTML = 'üìã Namuna yuklab olish (.xlsx)';
            const fileInput = document.getElementById('importFile');
            fileInput.parentNode.insertBefore(sampleBtn, fileInput);
        }
    }

    window.submitImport = async () => {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        if (!file) { alert("Fayl tanlang!"); return; }

        const formData = new FormData();
        formData.append('file', file);

        const apiUrl = currentImportActionUrl || config.importApi;
        if (!apiUrl) { alert("Import URL topilmadi"); return; }

        const token = localStorage.getItem('access_token');
        try {
            const res = await axios.post(apiUrl, formData, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'multipart/form-data'
                }
            });
            alert('Import muvaffaqiyatli! Qo\'shilganlar soni: ' + res.data.count);
            document.getElementById('importModal').classList.add('hidden');

            // Cleanup
            currentImportActionUrl = '';
            currentSampleUrl = '';
            fileInput.value = '';

            loadData(token);
        } catch (e) {
            alert('Import xatosi: ' + ((e.response && e.response.data && e.response.data.error) ? e.response.data.error :
                e.message));
        }
    }

    // Test Assignment Logic
    let currentTestIdForAssign = null;

    window.openAssignGroupModal = async (testId, testTitle) => {
        currentTestIdForAssign = testId;
        document.getElementById('assign-test-title').textContent = `Test: ${testTitle}`;
        const modal = document.getElementById('assignGroupModal');
        const container = document.getElementById('assign-group-container');

        modal.classList.remove('hidden');

        const token = localStorage.getItem('access_token');
        try {
            container.innerHTML = '<p class="text-sm text-gray-500">Yuklanmoqda...</p>';
            const res = await axios.get('/api/groups/?page_size=1000&is_system_active=true', {
                headers: {
                    Authorization: `Bearer
${token}`
                }
            });
            const groups = res.data.results || res.data;

            if (!groups || groups.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Guruhlar topilmadi</p>';
                return;
            }

            container.innerHTML = groups.map(g => `
<div class="flex items-center mb-2 px-2 py-1 hover:bg-gray-50 rounded border border-transparent hover:border-gray-200">
    <input type="checkbox" id="assign-g-${g.id}" value="${g.id}"
        class="group-assign-cb w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
    <label for="assign-g-${g.id}" class="ml-2 block text-sm text-gray-900 cursor-pointer w-full select-none">
        ${g.name} <span class="text-gray-400 text-xs">(${g.course}-kurs)</span>
    </label>
</div>
`).join('');

        } catch (e) {
            console.error(e);
            container.innerHTML = '<p class="text-sm text-red-500">Xatolik yuz berdi</p>';
        }
    }

    window.toggleAllGroups = (check) => {
        const cbs = document.querySelectorAll('.group-assign-cb');
        cbs.forEach(cb => cb.checked = check);
    }

    window.submitGroupAssignment = async () => {
        const cbs = document.querySelectorAll('.group-assign-cb:checked');
        const groupIds = Array.from(cbs).map(cb => cb.value);

        if (groupIds.length === 0) {
            showModal('Xatolik', "Iltimos, kamida bitta guruhni tanlang");
            return;
        }

        const token = localStorage.getItem('access_token');
        try {
            // We send list of IDs
            const res = await axios.post(`/api/tests/${currentTestIdForAssign}/assign-group/`,
                { group_ids: groupIds },
                { headers: { Authorization: `Bearer ${token}` } }
            );

            showModal('Muvaffaqiyatli', res.data.message);
            document.getElementById('assignGroupModal').classList.add('hidden');
        } catch (e) {
            console.error(e);
            showModal('Xatolik', e.response?.data?.error || "Biriktirishda xatolik yuz berdi");
        }
    }

    // --- EMPLOYEE MODAL LOGIC ---
    const EMP_MODULES = [
        { val: 'dashboard', text: 'Bosh sahifa' },
        { val: 'monitoring', text: 'Monitoring' },
        { val: 'groups', text: 'Guruhlar' },
        { val: 'students', text: 'Talabalar' },
        { val: 'results', text: 'Natijalar' },
        { val: 'vedmost', text: 'Vedmost' },
        { val: 'directions', text: 'Yo\'nalishlar' },
        { val: 'subjects', text: 'Fanlar' },
        { val: 'tests', text: 'Testlar' },
        { val: 'employees', text: 'Xodimlar' },
        { val: 'log_system', text: 'Loglar' }
    ];

    window.openEmployeeModal = async (id = null) => {
        currentId = id; // Global ID reuse
        document.getElementById('employeeModalTitle').textContent = id ? "Xodimni Tahrirlash" : "Yangi Xodim Qo'shish";
        document.getElementById('emp-password-req').classList.toggle('hidden', !!id);

        // Clear Inputs
        ['first_name', 'last_name', 'username', 'password', 'phone'].forEach(f => document.getElementById(`emp-${f}`).value = '');

        // Generate Permissions Table
        const tbody = document.getElementById('emp-permissions-body');
        tbody.innerHTML = EMP_MODULES.map(mod => `
            <tr class="hover:bg-gray-50 transition border-b last:border-0 group">
                <td class="px-4 py-3 text-sm font-medium text-gray-700">${mod.text}</td>
                <td class="px-2 py-3 text-center"><input type="checkbox" id="emp-perm-${mod.val}-view" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer transition"></td>
                <td class="px-2 py-3 text-center"><input type="checkbox" id="emp-perm-${mod.val}-update" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer transition"></td>
                <td class="px-2 py-3 text-center"><input type="checkbox" id="emp-perm-${mod.val}-create" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer transition"></td>
                <td class="px-2 py-3 text-center"><input type="checkbox" id="emp-perm-${mod.val}-delete" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer transition"></td>
                <td class="px-2 py-3 text-center"><input type="checkbox" id="emp-perm-${mod.val}-export" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer transition"></td>
                <td class="px-2 py-3 text-center"><input type="checkbox" onchange="toggleEmpRow('${mod.val}', this.checked)" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer transition opacity-50 hover:opacity-100 group-hover:opacity-100"></td>
            </tr>
        `).join('');

        // Fetch Data if Edit
        if (id) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await axios.get(`/api/employees/${id}/`, { headers: { Authorization: `Bearer ${token}` } });
                const data = res.data;

                document.getElementById('emp-first_name').value = data.first_name;
                document.getElementById('emp-last_name').value = data.last_name;
                document.getElementById('emp-username').value = data.username;
                document.getElementById('emp-phone').value = data.phone;

                // Set Permissions
                if (data.permissions) {
                    data.permissions.forEach(p => {
                        if (p.module) {
                            ['view', 'update', 'create', 'delete', 'export'].forEach(act => {
                                const cb = document.getElementById(`emp-perm-${p.module}-${act}`);
                                if (cb) cb.checked = p[`can_${act}`];
                            });
                        }
                    });
                }
            } catch (e) {
                console.error(e);
                showModal('Xatolik', 'Ma\'lumotlarni yuklashda xatolik');
                return;
            }
        } else {
            // Defaults for new User? or Empty?
            // Maybe set View for all by default? No, clean slate is better or use presets.
        }

        document.getElementById('employeeModal').classList.remove('hidden');
    }

    window.closeEmployeeModal = () => {
        document.getElementById('employeeModal').classList.add('hidden');
    }

    window.toggleEmpRow = (mod, checked) => {
        ['view', 'update', 'create', 'delete', 'export'].forEach(act => {
            const cb = document.getElementById(`emp-perm-${mod}-${act}`);
            if (cb) cb.checked = checked;
        });
    }

    window.presetPermissions = (role) => {
        // Reset first
        document.querySelectorAll('#emp-permissions-body input[type="checkbox"]').forEach(c => c.checked = false);

        if (role === 'dean') {
            const modules = ['dashboard', 'groups', 'students', 'results', 'directions', 'subjects', 'tests', 'employees'];
            modules.forEach(m => toggleEmpRow(m, true));
        } else if (role === 'teacher') {
            ['dashboard', 'groups', 'students', 'subjects', 'tests', 'results'].forEach(m => {
                document.getElementById(`emp-perm-${m}-view`).checked = true;
            });
            // Teachers can create/edit tests and results
            ['tests', 'results'].forEach(m => {
                document.getElementById(`emp-perm-${m}-create`).checked = true;
                document.getElementById(`emp-perm-${m}-update`).checked = true;
            });
        }
    }

    window.saveEmployee = async () => {
        const token = localStorage.getItem('access_token');
        const firstName = document.getElementById('emp-first_name').value;
        const lastName = document.getElementById('emp-last_name').value;
        const username = document.getElementById('emp-username').value;
        const password = document.getElementById('emp-password').value;
        const phone = document.getElementById('emp-phone').value;

        if (!firstName || !lastName || !username) {
            showModal('Diqqat', 'Ism, Familiya va Login maydonlari majburiy!');
            return;
        }

        if (!currentId && !password) {
            showModal('Diqqat', 'Yangi xodim uchun parol majburiy!');
            return;
        }

        const payload = {
            first_name: firstName,
            last_name: lastName,
            username: username,
            phone: phone,
            role: 'teacher' // Default role for manual creation
        };

        if (password) payload.password = password;

        // Collect Permissions
        const permissions = [];
        EMP_MODULES.forEach(mod => {
            const row = { module: mod.val };
            let hasAny = false;
            ['view', 'update', 'create', 'delete', 'export'].forEach(act => {
                const cb = document.getElementById(`emp-perm-${mod.val}-${act}`);
                if (cb && cb.checked) {
                    row[`can_${act}`] = true;
                    hasAny = true;
                } else {
                    row[`can_${act}`] = false;
                }
            });
            if (hasAny) permissions.push(row);
        });

        payload.module_accesses = permissions; // Backend expects 'module_accesses' in create/update on CustomUserSerializer? 
        // Wait, CustomUserSerializer uses `permissions = ModuleAccessSerializer(source='module_accesses'...)`
        // So validation/input might expect 'permissions' or 'module_accesses'. 
        // Serializer field is 'permissions', source is 'module_accesses'.
        // In DRF ModelSerializer, if I send 'permissions', it maps to 'module_accesses' via source if writable?
        // Actually, CustomUserSerializer has `permissions = ...`.
        // Let's send `module_accesses` as the key because `serializers.py` `create` populates `permissions_data = validated_data.pop('module_accesses', [])`.
        // But the field name exposed in API is `permissions`.
        // Let's send `module_accesses` effectively, or just send `permissions` and hope DRF maps it back.
        // Actually in serializer `fields = (..., 'permissions', ...)`
        // If I send 'permissions' JSON, DRF serializer will receive it as `permissions`. 
        // But the source is `module_accesses`. 
        // safer to use the key that matched the serializer field name: 'permissions'.
        payload.permissions = permissions;

        try {
            if (currentId) {
                await axios.patch(`/api/employees/${currentId}/`, payload, { headers: { Authorization: `Bearer ${token}` } });
            } else {
                await axios.post(`/api/employees/`, payload, { headers: { Authorization: `Bearer ${token}` } });
            }

            closeEmployeeModal();
            loadData(token, currentPage);
            showModal('Muvaffaqiyatli', 'Xodim ma\'lumotlari saqlandi');
        } catch (error) {
            console.error(error);
            let msg = 'Saqlashda xatolik';
            if (error.response && error.response.data) {
                // Formatting error
                msg = Object.entries(error.response.data).map(([k, v]) => `${k}: ${v}`).join('\n');
            }
            showModal('Xatolik', msg);
        }
    }

    // Bulk Actions Logic
    window.toggleAll = (checked) => {
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = checked);
        updateToolbar();
    };

    window.updateToolbar = () => {
        const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
        document.getElementById('selected-count').textContent = checkedCount;
        const toolbar = document.getElementById('bulk-actions');

        if (checkedCount > 0) {
            toolbar.classList.remove('hidden');
        } else {
            toolbar.classList.add('hidden');
            const masterCb = document.getElementById('select-all-cb');
            if (masterCb) masterCb.checked = false;
        }
    };

    window.clearSelection = () => {
        toggleAll(false);
    };

    window.executeBulkAction = async (action) => {
        const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.value));
        if (selectedIds.length === 0) return;

        let confirmMsg = '';
        if (action === 'delete') confirmMsg = `Haqiqatan ham ${selectedIds.length} ta elementni o'chirmoqchimisiz?`;
        else if (action === 'retake') confirmMsg = `Haqiqatan ham ${selectedIds.length} ta talabaga qayta topshirishga ruxsat bermoqchimisiz?`;
        else if (action === 'activate') confirmMsg = `Haqiqatan ham ${selectedIds.length} ta elementni faollashtirmoqchimisiz?`;
        else if (action === 'deactivate') confirmMsg = `Haqiqatan ham ${selectedIds.length} ta elementni nofaol qilmoqchimisiz?`;

        showModal('Tasdiqlash', confirmMsg, async () => {
            const token = localStorage.getItem('access_token');
            try {
                const res = await axios.post(`${config.api}bulk_action/`, {
                    action: action,
                    ids: selectedIds
                }, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                let successMsg = "Bajarildi";
                if (action === 'delete') successMsg = "O'chirildi";
                else if (action === 'retake') successMsg = "Ruxsat berildi";
                else if (action === 'activate') successMsg = "Faollashtirildi";
                else if (action === 'deactivate') successMsg = "Nofaol qilindi";

                showModal('Muvaffaqiyatli', successMsg);
                loadData(token, currentPage);
                clearSelection();
            } catch (e) {
                console.error(e);
                showModal('Xatolik', 'Amaliyot bajarilmadi. ' + (e.response?.data?.error || ''));
            }
        });
    };

    window.archiveItem = async (id) => {
        showModal('Tasdiqlash', 'Haqiqatan ham ushbu testni arxivlashni xohlaysizmi?', async () => {
            const token = localStorage.getItem('access_token');
            try {
                await axios.post(`/api/tests/${id}/archive/`, {}, { headers: { Authorization: `Bearer ${token}` } });
                loadData(token, currentPage);
                showModal('Muvaffaqiyatli', 'Test muvaffaqiyatli arxivlandi');
            } catch (e) {
                showModal('Xatolik', 'Amaliyot bajarilmadi. ' + (e.response?.data?.error || e.message));
            }
        });
    };

    window.unarchiveItem = async (id) => {
        showModal('Tasdiqlash', 'Haqiqatan ham ushbu testni arxivdan chiqarishni xohlaysizmi?', async () => {
            const token = localStorage.getItem('access_token');
            try {
                await axios.post(`/api/tests/${id}/unarchive/`, {}, { headers: { Authorization: `Bearer ${token}` } });
                loadData(token, currentPage);
                showModal('Muvaffaqiyatli', 'Test arxivdan chiqarildi');
            } catch (e) {
                showModal('Xatolik', 'Amaliyot bajarilmadi. ' + (e.response?.data?.error || e.message));
            }
        });
    };

    function logout() {
        localStorage.removeItem('access_token');
        window.location.href = '/login/';
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        if (sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    }
</script>
{% endblock %}